---
layout: post
title: '给UITableViewCell动态调整高度'
date: 2011-12-30 15:25:01 +0800
categories: [iOS]
csdn_read_num: 12676
article_type: 1
---


<p>在网上看到有人如此实现动态调整高度：<a target=_blank target="_blank" href="http://www.cnblogs.com/batys/archive/2011/10/18/2216434.html">点击</a>。</p><p>不至于为了获取高度创建一个不需要的cell。</p><p>主要有两个地方需要调整高度，一个是自己创建的UILabel或其它子视图，另一个就是cell的高度。</p><p>cell内部的view的frame通过重写cell的layoutSubviews方法就行了，就也是一种标准做法：</p><p></p><div style="font-family: sans-serif; font-size: 16px; line-height: 110% !important; background-color: rgb(248, 248, 255) !important; border: 1px solid rgba(0, 0, 0, 0.14902) !important; padding: 8.5px !important; border-top-left-radius: 4px !important; border-top-right-radius: 4px !important; border-bottom-right-radius: 4px !important; border-bottom-left-radius: 4px !important;"><p style="margin-top: 0px; margin-bottom: 0px; font-size: 11px; font-family: Menlo;">-(<span style="color: rgb(187, 44, 162);">void</span>)layoutSubviews{</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 11px; font-family: Menlo; color: rgb(61, 29, 129);"><span style="color: rgb(0, 0, 0);">&nbsp; &nbsp; [</span><span style="color: rgb(187, 44, 162);">super</span><span style="color: rgb(0, 0, 0);">&nbsp;</span>layoutSubviews<span style="color: rgb(0, 0, 0);">];</span></p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 11px; font-family: Menlo; min-height: 13px;">&nbsp;&nbsp; &nbsp;</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 11px; font-family: Menlo; color: rgb(79, 129, 135);"><span style="color: rgb(0, 0, 0);">&nbsp; &nbsp;&nbsp;</span><span style="color: rgb(187, 44, 162);">self</span><span style="color: rgb(0, 0, 0);">.</span>headImageView<span style="color: rgb(0, 0, 0);">.</span>origin<span style="color: rgb(0, 0, 0);">&nbsp;=&nbsp;</span><span style="color: rgb(61, 29, 129);">CGPointMake</span><span style="color: rgb(0, 0, 0);">(</span><span style="color: rgb(39, 42, 216);">10</span><span style="color: rgb(0, 0, 0);">,&nbsp;</span><span style="color: rgb(39, 42, 216);">10</span><span style="color: rgb(0, 0, 0);">);</span></p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 11px; font-family: Menlo; color: rgb(79, 129, 135);"><span style="color: rgb(0, 0, 0);">&nbsp; &nbsp;&nbsp;</span><span style="color: rgb(187, 44, 162);">self</span><span style="color: rgb(0, 0, 0);">.</span>userNameLabel<span style="color: rgb(0, 0, 0);">.</span>size<span style="color: rgb(0, 0, 0);">&nbsp;=&nbsp;</span><span style="color: rgb(49, 89, 93);">getTextSize</span><span style="color: rgb(0, 0, 0);">(</span><span style="color: rgb(187, 44, 162);">self</span><span style="color: rgb(0, 0, 0);">.</span>userNameLabel<span style="color: rgb(0, 0, 0);">.</span><span style="color: rgb(112, 61, 170);">font</span><span style="color: rgb(0, 0, 0);">,&nbsp;</span><span style="color: rgb(187, 44, 162);">self</span><span style="color: rgb(0, 0, 0);">.</span>userNameLabel<span style="color: rgb(0, 0, 0);">.</span><span style="color: rgb(112, 61, 170);">text</span><span style="color: rgb(0, 0, 0);">,</span></p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 11px; font-family: Menlo;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<span style="color: rgb(187, 44, 162);">self</span>.<span style="color: rgb(112, 61, 170);">contentView</span>.<span style="color: rgb(79, 129, 135);">width</span>&nbsp;-&nbsp;<span style="color: rgb(187, 44, 162);">self</span>.<span style="color: rgb(79, 129, 135);">headImageView</span>.<span style="color: rgb(79, 129, 135);">right</span>);</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 11px; font-family: Menlo; color: rgb(79, 129, 135);"><span style="color: rgb(0, 0, 0);">&nbsp; &nbsp;&nbsp;</span><span style="color: rgb(187, 44, 162);">self</span><span style="color: rgb(0, 0, 0);">.</span>userNameLabel<span style="color: rgb(0, 0, 0);">.</span>origin<span style="color: rgb(0, 0, 0);">&nbsp;=&nbsp;</span><span style="color: rgb(61, 29, 129);">CGPointMake</span><span style="color: rgb(0, 0, 0);">(</span><span style="color: rgb(187, 44, 162);">self</span><span style="color: rgb(0, 0, 0);">.</span>headImageView<span style="color: rgb(0, 0, 0);">.</span>right<span style="color: rgb(0, 0, 0);">&nbsp;+&nbsp;</span><span style="color: rgb(39, 42, 216);">10</span><span style="color: rgb(0, 0, 0);">,&nbsp;</span><span style="color: rgb(187, 44, 162);">self</span><span style="color: rgb(0, 0, 0);">.</span>headImageView<span style="color: rgb(0, 0, 0);">.</span>y<span style="color: rgb(0, 0, 0);">);</span></p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 11px; font-family: Menlo; color: rgb(79, 129, 135);"><span style="color: rgb(0, 0, 0);"></span></p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 11px; font-family: Menlo;">}</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 11px; font-family: Menlo; color: rgb(79, 129, 135);"><span style="color: rgb(0, 0, 0);"></span></p></div>内部子视图的计算全部基于cell.contentView（因为子视图一般都是加在contentView上的）来计算。<p></p><p>而layoutSubviews方法会在cell的frame发生变化的时候调用，而cell高度的计算只能放在heightForRowAtIndexPath方法里进行，所以我们只用在heightForRowAtIndexPath方法里返回正确的高度就行了，至于计算方法，应该放在cell的一个类方法里，因为只有cell本身才知道自己内部的情况，这也是更好的封装内部实现：<span style="font-family: sans-serif; font-size: 16px;">&nbsp;</span></p><p></p><div style="font-family: sans-serif; font-size: 16px; line-height: 110% !important; background-color: rgb(248, 248, 255) !important; border: 1px solid rgba(0, 0, 0, 0.14902) !important; padding: 8.5px !important; border-top-left-radius: 4px !important; border-top-right-radius: 4px !important; border-bottom-right-radius: 4px !important; border-bottom-left-radius: 4px !important;"><p style="margin-top: 0px; margin-bottom: 0px; font-size: 11px; font-family: Menlo;">+(<span style="color: rgb(112, 61, 170);">CGFloat</span>)heightForDynamicCell:(<span style="color: rgb(79, 129, 135);">MSDynamic</span>&nbsp;*)dynamic;</p></div><p></p><p>内部实现就是计算cell需要的高度：</p><p></p><div style="font-family: sans-serif; font-size: 16px; line-height: 110% !important; background-color: rgb(248, 248, 255) !important; border: 1px solid rgba(0, 0, 0, 0.14902) !important; padding: 8.5px !important; border-top-left-radius: 4px !important; border-top-right-radius: 4px !important; border-bottom-right-radius: 4px !important; border-bottom-left-radius: 4px !important;"><p style="margin-top: 0px; margin-bottom: 0px; font-size: 11px; font-family: Menlo;">+(<span style="color: rgb(112, 61, 170);">CGFloat</span>)heightForDynamicCell:(<span style="color: rgb(79, 129, 135);">MSDynamic</span>&nbsp;*)dynamic {</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 11px; font-family: Menlo;">&nbsp; &nbsp;&nbsp;<span style="color: rgb(187, 44, 162);">static</span>&nbsp;<span style="color: rgb(112, 61, 170);">CGFloat</span>&nbsp;contentLabelY =&nbsp;<span style="color: rgb(39, 42, 216);">40.3f</span>;</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 11px; font-family: Menlo;">&nbsp; &nbsp;&nbsp;<span style="color: rgb(112, 61, 170);">CGFloat</span>&nbsp;contentHeight =&nbsp;<span style="color: rgb(49, 89, 93);">getTextSize</span>(<span style="color: rgb(120, 73, 42);">ContentLabelFont</span>, dynamic.<span style="color: rgb(79, 129, 135);">content</span>,&nbsp;<span style="color: rgb(120, 73, 42);">ContentLabelMaxWidth</span>).<span style="color: rgb(112, 61, 170);">height</span>;</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 11px; font-family: Menlo; min-height: 13px;">&nbsp;&nbsp; &nbsp;</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 11px; font-family: Menlo;">&nbsp; &nbsp;&nbsp;<span style="color: rgb(187, 44, 162);">float</span>&nbsp;contentImageViewHeight ;</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 11px; font-family: Menlo;">&nbsp; &nbsp;&nbsp;<span style="color: rgb(187, 44, 162);">if</span>&nbsp;(dynamic.<span style="color: rgb(79, 129, 135);">contentImgList</span>.<span style="color: rgb(112, 61, 170);">count</span>) {</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 11px; font-family: Menlo;">&nbsp; &nbsp; &nbsp; &nbsp; contentImageViewHeight = [<span style="color: rgb(79, 129, 135);">MSDynamicContentImageView</span>&nbsp;<span style="color: rgb(49, 89, 93);">heightForDynamicContentImage</span>:dynamic];</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 11px; font-family: Menlo;">&nbsp; &nbsp; }&nbsp;<span style="color: rgb(187, 44, 162);">else</span>&nbsp;{</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 11px; font-family: Menlo;">&nbsp; &nbsp; &nbsp; &nbsp; contentImageViewHeight = -<span style="color: rgb(39, 42, 216);">10</span>;</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 11px; font-family: Menlo;">&nbsp; &nbsp; }</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 11px; font-family: Menlo; min-height: 13px;">&nbsp;&nbsp; &nbsp;</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 11px; font-family: Menlo;">&nbsp; &nbsp;&nbsp;<span style="color: rgb(187, 44, 162);">return</span>&nbsp;contentLabelY + contentHeight +&nbsp;<span style="color: rgb(39, 42, 216);">10</span>&nbsp;+ contentImageViewHeight +&nbsp;<span style="color: rgb(39, 42, 216);">10</span>;</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 11px; font-family: Menlo;">}</p></div>这里面还有进一步对其他子视图高度计算的封装，思想是一样的，最终返回cell需要的高度就行了。<p></p><p>在<span style="font-family: Menlo; font-size: 11px;">heightForRowAtIndexPath方法中把对应的Model给cell即可：</span></p><p></p><div style="font-family: sans-serif; font-size: 16px; line-height: 110% !important; background-color: rgb(248, 248, 255) !important; border: 1px solid rgba(0, 0, 0, 0.14902) !important; padding: 8.5px !important; border-top-left-radius: 4px !important; border-top-right-radius: 4px !important; border-bottom-right-radius: 4px !important; border-bottom-left-radius: 4px !important;"><p style="margin-top: 0px; margin-bottom: 0px; font-size: 11px; font-family: Menlo;">- (<span style="color: rgb(112, 61, 170);">CGFloat</span>)tableView:(<span style="color: rgb(112, 61, 170);">UITableView</span>&nbsp;*)tableView heightForRowAtIndexPath:(<span style="color: rgb(112, 61, 170);">NSIndexPath</span>&nbsp;*)indexPath {</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 11px; font-family: Menlo;">&nbsp; &nbsp;&nbsp;<span style="color: rgb(79, 129, 135);">MSDynamic</span>&nbsp;*dynamic =&nbsp;<span style="color: rgb(187, 44, 162);">self</span>.<span style="color: rgb(79, 129, 135);">dynamicList</span>[indexPath.<span style="color: rgb(112, 61, 170);">row</span>];</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 11px; font-family: Menlo; color: rgb(49, 89, 93);"><span style="color: rgb(0, 0, 0);">&nbsp; &nbsp;&nbsp;</span><span style="color: rgb(187, 44, 162);">return</span><span style="color: rgb(0, 0, 0);">&nbsp;[</span><span style="color: rgb(79, 129, 135);">MSDynamicCell</span><span style="color: rgb(0, 0, 0);">&nbsp;</span>heightForDynamicCell<span style="color: rgb(0, 0, 0);">:dynamic];</span></p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 11px; font-family: Menlo;">}</p></div><p></p><p>getTextSize只是一个工具方法，用于计算text所需要的size：</p><p></p><div style="font-family: sans-serif; font-size: 16px; line-height: 110% !important; background-color: rgb(248, 248, 255) !important; border: 1px solid rgba(0, 0, 0, 0.14902) !important; padding: 8.5px !important; border-top-left-radius: 4px !important; border-top-right-radius: 4px !important; border-bottom-right-radius: 4px !important; border-bottom-left-radius: 4px !important;"><p style="margin-top: 0px; margin-bottom: 0px; font-size: 11px; font-family: Menlo;"><span style="color: rgb(112, 61, 170);">CGSize</span>&nbsp;getTextSize(<span style="color: rgb(112, 61, 170);">UIFont</span>&nbsp;*font,<span style="color: rgb(112, 61, 170);">NSString</span>&nbsp;*text,&nbsp;<span style="color: rgb(112, 61, 170);">CGFloat</span>&nbsp;maxWidth){</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 11px; font-family: Menlo; color: rgb(120, 73, 42);"><span style="color: rgb(0, 0, 0);">&nbsp; &nbsp;&nbsp;</span><span style="color: rgb(187, 44, 162);">if</span><span style="color: rgb(0, 0, 0);">&nbsp;(</span>iOS_VERSION_NOT_LESS_THAN_7<span style="color: rgb(0, 0, 0);">) {</span></p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 11px; font-family: Menlo;">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<span style="color: rgb(112, 61, 170);">CGSize</span>&nbsp;textSize = [text&nbsp;<span style="color: rgb(61, 29, 129);">boundingRectWithSize</span>:<span style="color: rgb(61, 29, 129);">CGSizeMake</span>(maxWidth,&nbsp;<span style="color: rgb(120, 73, 42);">MAXFLOAT</span>)</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 11px; font-family: Menlo; color: rgb(61, 29, 129);"><span style="color: rgb(0, 0, 0);">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span>options<span style="color: rgb(0, 0, 0);">:</span>NSStringDrawingUsesLineFragmentOrigin<span style="color: rgb(0, 0, 0);">|</span>NSStringDrawingUsesFontLeading</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 11px; font-family: Menlo;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<span style="color: rgb(61, 29, 129);">attributes</span>:<span style="color: rgb(39, 42, 216);">@{</span><span style="color: rgb(112, 61, 170);">NSFontAttributeName</span>: font<span style="color: rgb(39, 42, 216);">}</span></p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 11px; font-family: Menlo;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<span style="color: rgb(61, 29, 129);">context</span>:<span style="color: rgb(187, 44, 162);">nil</span>].<span style="color: rgb(112, 61, 170);">size</span>;</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 11px; font-family: Menlo;">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<span style="color: rgb(187, 44, 162);">return</span>&nbsp;textSize;</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 11px; font-family: Menlo;">&nbsp; &nbsp; }</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 11px; font-family: Menlo; min-height: 13px;">&nbsp;&nbsp; &nbsp;</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 11px; font-family: Menlo;">&nbsp; &nbsp;&nbsp;<span style="color: rgb(112, 61, 170);">CGSize</span>&nbsp;textSize = [text&nbsp;<span style="color: rgb(61, 29, 129);">sizeWithFont</span>:font</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 11px; font-family: Menlo;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<span style="color: rgb(61, 29, 129);">constrainedToSize</span>:<span style="color: rgb(61, 29, 129);">CGSizeMake</span>(maxWidth,&nbsp;<span style="color: rgb(120, 73, 42);">MAXFLOAT</span>)</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 11px; font-family: Menlo; color: rgb(61, 29, 129);"><span style="color: rgb(0, 0, 0);">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span>lineBreakMode<span style="color: rgb(0, 0, 0);">:</span>NSLineBreakByCharWrapping<span style="color: rgb(0, 0, 0);">];</span></p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 11px; font-family: Menlo;">&nbsp; &nbsp;&nbsp;<span style="color: rgb(187, 44, 162);">return</span>&nbsp;textSize;</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 11px; font-family: Menlo;">}</p></div><p></p><p>期间使用了一些公共宏，比如：MAXFLOAT等等,只在cellForRowAtIndexPath里面配置好cell，计算高度交给heightForRowAtIndexPath就行了。</p><p></p>