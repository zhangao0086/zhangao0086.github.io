---
layout: post
title: "iOS8 Core Image In Swift：自动改善图像以及内置滤镜的使用"
date: 2014-09-06 23:33:29
categories: [iOS,Swift]
---


<p></p><p>iOS8 Core Image In Swift：自动改善图像以及内置滤镜的使用</p><p><a target=_blank target="_blank" href="http://blog.csdn.net/zhangao0086/article/details/39120331">iOS8 Core Image In Swift：更复杂的滤镜</a><br /></p><p><a target=_blank target="_blank" href="http://blog.csdn.net/zhangao0086/article/details/39253707">iOS8 Core Image In Swift：人脸检测以及马赛克</a></p><p><a target=_blank href="http://blog.csdn.net/zhangao0086/article/details/39433519">iOS8 Core Image In Swift：视频实时滤镜</a><br /></p><p><a target=_blank target="_blank" href="http://blog.csdn.net/zhangao0086/article/details/39120331"></a></p><p><br /></p><p>Core Image是一个很强大的框架。它可以让你简单地应用各种滤镜来处理图像，比如修改鲜艳程度, 色泽, 或者曝光。 它利用GPU（或者CPU）来非常快速、甚至实时地处理图像数据和视频的帧。并且隐藏了底层图形处理的所有细节，通过提供的API就能简单的使用了，无须关心OpenGL或者OpenGL ES是如何充分利用GPU的能力的，也不需要你知道GCD在其中发挥了怎样的作用，Core Image处理了全部的细节。&nbsp;</p><p>Core Image框架给我们提供了这些东西：</p><p></p><ul><li>内置的图片滤镜</li><li>特征检测能力（如人脸识别）</li><li>支持自动改善图像</li><li>能利用多个滤镜组合成一个自定义滤镜</li></ul><p></p><p><br /></p><h2>自动改善图像</h2><p>先上一个简单的例子。用Single View Application的工程模板建立一个工程，这个工程建好后只有一个AppDelegate和一个ViewController，另外还有一个Main.storyboard，在Main.storyboard里已经准备好一个ViewController了，我们在这个ViewController里放置一个UIImageView，调整其frame：</p><p><img src="https://img-blog.csdn.net/20140902222607516?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvemhhbmdhbzAwODY=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="" /><br /></p><p>除此之外，因为UIImageView是默认拉伸图片的，我们不想让它变形，把它的ContentMode设置为<strong><span style="color:#cc0000;">Aspect Fit</span></strong>。顺便把Auto Layout和Size Classes关掉。</p><p>最后在拖两个按钮进来，一个用于显示原图，一个用于自动改善图像，整个ViewController看起来像这样：</p><p><img src="https://img-blog.csdn.net/20140902223615745?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvemhhbmdhbzAwODY=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="" /><br /></p><p>接下来在ViewController中增加对应的IBAction方法以及IBOutlet属性：</p><p></p><div style="font-family: sans-serif; font-size: 16px; margin: 10px 0px !important; line-height: 110% !important; background-color: rgb(248, 248, 255) !important; border: 1px solid rgba(0, 0, 0, 0.14902) !important; padding: 8.5px !important; border-top-left-radius: 4px !important; border-top-right-radius: 4px !important; border-bottom-right-radius: 4px !important; border-bottom-left-radius: 4px !important;"><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;"><span style="color: rgb(187, 44, 162);">class</span>&nbsp;ViewController:&nbsp;<span style="color: rgb(112, 61, 170);">UIViewController</span>&nbsp;{</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp;&nbsp;<span style="color: rgb(187, 44, 162);">@IBOutlet</span>&nbsp;<span style="color: rgb(187, 44, 162);">var</span>&nbsp;imageView:&nbsp;<span style="color: rgb(112, 61, 170);">UIImageView</span>!</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo; min-height: 13px;">&nbsp;&nbsp; &nbsp;</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp;&nbsp;<span style="color: rgb(187, 44, 162);">lazy</span>&nbsp;<span style="color: rgb(187, 44, 162);">var</span>&nbsp;originalImage:&nbsp;<span style="color: rgb(112, 61, 170);">UIImage</span>&nbsp;= {</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<span style="color: rgb(187, 44, 162);">return</span>&nbsp;<span style="color: rgb(112, 61, 170);">UIImage</span>(named:&nbsp;<span style="color: rgb(209, 47, 27);">&quot;Image&quot;</span>)</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp; }()</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">......</p></div>一个连接到Storyboard的imageView，还有一个只懒加载一次的originalImage属性，这个属性在后面会用到很多次，这里有我<a target=_blank target="_blank" href="https://img-blog.csdn.net/20140902225109455">整个工程用到的image</a>。<p></p><p>然后在ViewDidLoad里像这样：</p><p></p><div style="font-family: sans-serif; font-size: 16px; margin: 10px 0px !important; line-height: 110% !important; background-color: rgb(248, 248, 255) !important; border: 1px solid rgba(0, 0, 0, 0.14902) !important; padding: 8.5px !important; border-top-left-radius: 4px !important; border-top-right-radius: 4px !important; border-bottom-right-radius: 4px !important; border-bottom-left-radius: 4px !important;"><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;"><span style="color: rgb(187, 44, 162);">override</span>&nbsp;<span style="color: rgb(187, 44, 162);">func</span>&nbsp;viewDidLoad() {</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo; color: rgb(61, 29, 129);"><span style="color: rgb(0, 0, 0);">&nbsp; &nbsp;&nbsp;</span><span style="color: rgb(187, 44, 162);">super</span><span style="color: rgb(0, 0, 0);">.</span>viewDidLoad<span style="color: rgb(0, 0, 0);">()</span></p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo; color: rgb(112, 61, 170);"><span style="color: rgb(0, 0, 0);">&nbsp; &nbsp;&nbsp;</span><span style="color: rgb(187, 44, 162);">self</span><span style="color: rgb(0, 0, 0);">.</span><span style="color: rgb(79, 129, 135);">imageView</span><span style="color: rgb(0, 0, 0);">.</span>layer<span style="color: rgb(0, 0, 0);">.</span>shadowOpacity<span style="color: rgb(0, 0, 0);">&nbsp;=&nbsp;</span><span style="color: rgb(39, 42, 216);">0.8</span></p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo; color: rgb(112, 61, 170);"><span style="color: rgb(0, 0, 0);">&nbsp; &nbsp;&nbsp;</span><span style="color: rgb(187, 44, 162);">self</span><span style="color: rgb(0, 0, 0);">.</span><span style="color: rgb(79, 129, 135);">imageView</span><span style="color: rgb(0, 0, 0);">.</span>layer<span style="color: rgb(0, 0, 0);">.</span>shadowColor<span style="color: rgb(0, 0, 0);">&nbsp;=&nbsp;</span>UIColor<span style="color: rgb(0, 0, 0);">.</span><span style="color: rgb(61, 29, 129);">blackColor</span><span style="color: rgb(0, 0, 0);">().</span>CGColor</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp;&nbsp;<span style="color: rgb(187, 44, 162);">self</span>.<span style="color: rgb(79, 129, 135);">imageView</span>.<span style="color: rgb(112, 61, 170);">layer</span>.<span style="color: rgb(112, 61, 170);">shadowOffset</span>&nbsp;=&nbsp;<span style="color: rgb(112, 61, 170);">CGSize</span>(width:&nbsp;<span style="color: rgb(39, 42, 216);">1</span>, height:&nbsp;<span style="color: rgb(39, 42, 216);">1</span>)</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo; min-height: 13px;">&nbsp;&nbsp; &nbsp;</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo; color: rgb(79, 129, 135);"><span style="color: rgb(0, 0, 0);">&nbsp; &nbsp;&nbsp;</span><span style="color: rgb(187, 44, 162);">self</span><span style="color: rgb(0, 0, 0);">.</span>imageView<span style="color: rgb(0, 0, 0);">.</span><span style="color: rgb(112, 61, 170);">image</span><span style="color: rgb(0, 0, 0);">&nbsp;=&nbsp;</span>originalImage</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">}</p></div><p>只做了两件事：一是给imageView加上了阴影边框，只是为了好看；二是把originalImage赋值给imageView。</p><p>一行代码显示原图：</p><p></p><div style="font-family: sans-serif; font-size: 16px; margin: 10px 0px !important; line-height: 110% !important; background-color: rgb(248, 248, 255) !important; border: 1px solid rgba(0, 0, 0, 0.14902) !important; padding: 8.5px !important; border-top-left-radius: 4px !important; border-top-right-radius: 4px !important; border-bottom-right-radius: 4px !important; border-bottom-left-radius: 4px !important;"><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;"><span style="color: rgb(187, 44, 162);">@IBAction</span>&nbsp;<span style="color: rgb(187, 44, 162);">func</span>&nbsp;showOriginalImage() {</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo; color: rgb(79, 129, 135);"><span style="color: rgb(0, 0, 0);">&nbsp; &nbsp;&nbsp;</span><span style="color: rgb(187, 44, 162);">self</span><span style="color: rgb(0, 0, 0);">.</span>imageView<span style="color: rgb(0, 0, 0);">.</span><span style="color: rgb(112, 61, 170);">image</span><span style="color: rgb(0, 0, 0);">&nbsp;=&nbsp;</span>originalImage</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">}</p></div><p></p><p>下面是自动改善的代码，我先贴出来，再慢慢说，有一个直观的效果会更有兴趣一些：</p><p></p><div style="font-family: sans-serif; font-size: 16px; margin: 10px 0px !important; line-height: 110% !important; background-color: rgb(248, 248, 255) !important; border: 1px solid rgba(0, 0, 0, 0.14902) !important; padding: 8.5px !important; border-top-left-radius: 4px !important; border-top-right-radius: 4px !important; border-bottom-right-radius: 4px !important; border-bottom-left-radius: 4px !important;"><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;"><span style="color: rgb(187, 44, 162);">@IBAction</span>&nbsp;<span style="color: rgb(187, 44, 162);">func</span>&nbsp;autoAdjust() {</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp;&nbsp;<span style="color: rgb(187, 44, 162);">var</span>&nbsp;inputImage =&nbsp;<span style="color: rgb(112, 61, 170);">CIImage</span>(image:&nbsp;<span style="color: rgb(79, 129, 135);">originalImage</span>)</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp;&nbsp;<span style="color: rgb(187, 44, 162);">let</span>&nbsp;filters = inputImage.<span style="color: rgb(61, 29, 129);">autoAdjustmentFilters</span>()&nbsp;<span style="color: rgb(187, 44, 162);">as</span>&nbsp;[<span style="color: rgb(112, 61, 170);">CIFilter</span>]</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp;&nbsp;<span style="color: rgb(187, 44, 162);">for</span>&nbsp;filter:&nbsp;<span style="color: rgb(112, 61, 170);">CIFilter</span>&nbsp;<span style="color: rgb(187, 44, 162);">in</span>&nbsp;filters {</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp; &nbsp; &nbsp; filter.<span style="color: rgb(61, 29, 129);">setValue</span>(inputImage, forKey:&nbsp;<span style="color: rgb(112, 61, 170);">kCIInputImageKey</span>)</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp; &nbsp; &nbsp; inputImage = filter.<span style="color: rgb(112, 61, 170);">outputImage</span></p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp; }</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp;&nbsp;<span style="color: rgb(187, 44, 162);">self</span>.<span style="color: rgb(79, 129, 135);">imageView</span>.<span style="color: rgb(112, 61, 170);">image</span>&nbsp;=&nbsp;<span style="color: rgb(112, 61, 170);">UIImage</span>(CIImage: inputImage)</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">}</p></div>把IBAction和IBOutlet连接对之后，运行起来应该就能看到以下效果了：<p><img src="https://img-blog.csdn.net/20140906173657801?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvemhhbmdhbzAwODY=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="" /><br /></p><p>点击自动改善就能看到效果了，可能运行会有点慢，因为我们还没做优化，如果觉得改善效果不明显的话，可以多点击几次原图来对比一下。</p><p>虽然有些问题，但是已经不妨碍我们继续探索了。上面的自动改善代码显式地用到了两个类（我为什么在这里要用显式这个词？）：CIImage和CIFilter，其中：</p><p></p><ul><li><strong><span style="color:#cc0000;">CIImage</span></strong>：这是一个模型对象，它保存能构建图像的数据，可以是图像的Data，可以是一个文件，也可以是CIFilter输出的对象。</li><li><strong><span style="color:#cc0000;">CIFilter</span></strong>：滤镜，不同的CIFilter实例能表示不同的滤镜效果，不同的滤镜所能设置的参数也不尽相同，但它至少需要一个输入参数以及能生成一个输出对象。</li></ul>另外Core Image的自动改善功能能智能的对图像的柱状图（histogram？）、人脸区域以及元数据进行分析，只需要传入一个Image作为输入参数，就能得到一组能使图像改善的滤镜。<div>CIImage的实例能通过UIImage来得到，然后通过两个API：<span style="color:#cc0000;">autoAdjustmentFilters</span>和<span style="color:#cc0000;">autoAdjustmentFiltersWithOptions:</span>取到能使图像得到改善的滤镜数组，在大多数情况下，你可能会用提供Option字典的那个API，因为你能设置：</div><div><ul><li>图片的方向，这对CIRedEyeCorrection、CIFaceBalance等滤镜来说格外重要，因为Core Image需要精确的对面部进行检测。</li><li>是否只需要消除红眼（设置kCIImageAutoAdjustEnhance为false）。</li><li>是否使用除了消除红眼以外的所有的滤镜（设置kCIImageAutoAdjustRedEye为false）。</li></ul><div>如果你想提供Option字典，那么可以这样使用：</div><div><pre code_snippet_id="465165" snippet_file_name="blog_20140906_1_4843615"  code_snippet_id="465165" snippet_file_name="blog_20140906_1_4843615" name="code" class="plain">NSDictionary *options = @{ CIDetectorImageOrientation :
                 [[image properties] valueForKey:kCGImagePropertyOrientation] };
NSArray *adjustments = [myImage autoAdjustmentFiltersWithOptions:options];</pre>在这个例子中，我就不传入Option字典了，因为不涉及图片方向的问题。</div><div>想知道自动改善功能用了哪些滤镜？只需要把filter对象打印出来即可，一般来说，会是这5个滤镜：</div></div><div><ul><li><strong><span style="color:#cc0000;">CIRedEyeCorrection</span></strong>：修复因相机的闪光灯导致的各种红眼</li><li><strong><span style="color:#cc0000;">CIFaceBalance</span></strong>：调整肤色</li><li><strong><span style="color:#cc0000;">CIVibrance</span></strong>：在不影响肤色的情况下，改善图像的饱和度</li><li><strong><span style="color:#cc0000;">CIToneCurve</span></strong>：改善图像的对比度</li><li><strong><span style="color:#cc0000;">CIHighlightShadowAdjust</span></strong>：改善阴影细节</li></ul><div>大部分情况下这些滤镜就够用了。</div></div><div>之前也提到了，不同的CIFilter会有不同的参数，如果我们想知道CIFilter具体有哪些参数，可以调用它自己的<span style="color:#cc0000;"><strong>inputKeys</strong></span>方法，得到它支持的输入参数的列表，或者调用它的<span style="color:#cc0000;"><strong>outputKeys</strong></span>方法，得到它的输出参数的列表（一般我们只用outpuntImage就行了），又或者直接调用它的<strong><span style="color:#cc0000;">attributes</span></strong>方法，得到它的所有信息，包括它的名字、所属的分类、输入参数、输出参数、各参数的取值范围以及默认值等。</div><div>调用CIFilter的inputKeys方法可以看到它的输入参数：</div><p></p><div style="font-family: sans-serif; font-size: 16px; margin: 10px 0px !important; line-height: 110% !important; background-color: rgb(248, 248, 255) !important; border: 1px solid rgba(0, 0, 0, 0.14902) !important; padding: 8.5px !important; border-top-left-radius: 4px !important; border-top-right-radius: 4px !important; border-bottom-right-radius: 4px !important; border-bottom-left-radius: 4px !important;"><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;"><span style="color: rgb(187, 44, 162);">for</span>&nbsp;filter:&nbsp;<span style="color: rgb(112, 61, 170);">CIFilter</span>&nbsp;<span style="color: rgb(187, 44, 162);">in</span>&nbsp;filters {</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp;&nbsp;<span style="color: rgb(187, 44, 162);">let</span>&nbsp;inputKeys = filter.<span style="color: rgb(61, 29, 129);">inputKeys</span>()</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp;&nbsp;<span style="color: rgb(61, 29, 129);">print</span>(filter.<span style="color: rgb(61, 29, 129);">name</span>())</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp;&nbsp;<span style="color: rgb(61, 29, 129);">println</span>(inputKeys)</p><p style="margin-top: 5px; margin-bottom: 5px;">...</p></div><p></p><p>打印结果：</p><p></p><pre code_snippet_id="465165" snippet_file_name="blog_20140906_2_3479630"  code_snippet_id="465165" snippet_file_name="blog_20140906_2_3479630" name="code" class="plain">CIFaceBalance[inputImage, inputOrigI, inputOrigQ, inputStrength, inputWarmth]
CIVibrance[inputImage, inputAmount]
CIToneCurve[inputImage, inputPoint0, inputPoint1, inputPoint2, inputPoint3, inputPoint4]
CIHighlightShadowAdjust[inputImage, inputRadius, inputShadowAmount, inputHighlightAmount]</pre><p>几乎所有的滤镜都有<strong><span style="color:#cc0000;">inputImage</span></strong>这个输入参数，我们可以直接用系统预置的各种key来设置参数（如<span style="color: rgb(112, 61, 170); font-family: Menlo;">kCIInputImageKey</span><span style="color: rgb(112, 61, 170);">），</span>系统已经预置了大部分常用的key，如果你发现有的key系统没有预置，你可以直接使用获取的key名的字符串来作key，如：</p><p></p><div style="font-family: sans-serif; font-size: 16px; margin: 10px 0px !important; line-height: 110% !important; background-color: rgb(248, 248, 255) !important; border: 1px solid rgba(0, 0, 0, 0.14902) !important; padding: 8.5px !important; border-top-left-radius: 4px !important; border-top-right-radius: 4px !important; border-bottom-right-radius: 4px !important; border-bottom-left-radius: 4px !important;"><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">filter.<span style="color: rgb(61, 29, 129);">setValue</span>(inputImage, forKey:&nbsp;<span style="color: rgb(112, 61, 170);">kCIInputImageKey</span>)</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: 'Heiti SC Light'; color: rgb(0, 132, 0);"><span style="font-family: Menlo;">//</span>两者设置方式完全一样</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">filter.<span style="color: rgb(61, 29, 129);">setValue</span>(inputImage, forKey:&nbsp;<span style="color: rgb(209, 47, 27);">&quot;inputImage&quot;</span>)<span style="font-family: sans-serif; font-size: 16px;">&nbsp;</span></p></div>对自动改善图像功能来说，我们不需要知道太多的细节，设置inputImage就可以了。<p></p><p>接下来填坑。</p><p>上面的代码有两个问题：一是在每次使用自动改善的过程中感觉到明显的慢；二是图像在自动改善后变形了。原图和改善后的图像对比：</p><p><img src="https://img-blog.csdn.net/20140906173657801?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvemhhbmdhbzAwODY=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="" /><img src="https://img-blog.csdn.net/20140906173702357?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvemhhbmdhbzAwODY=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="" /><br /></p><p>我把UIImageView的contentMode设置为<strong><span style="color:#cc0000;">Aspect Fit</span></strong>，就是不希望图片发生变形，而是按等比例缩放，如果把UIImageView的背景色设置为红色的话，在显示原图的时候可以看到上下<span style="color:#cc0000;">均有红色</span>，而改善之后的图片就<span style="color:#cc0000;">没有红色</span>。由于苹果表示UIImage是完全支持CIImage的，所以文档中并没有指出出现这个问题的原因，我参考了下面这个贴子：</p><p><a target=_blank target="_blank" href="http://stackoverflow.com/questions/15878060/setting-uiimageview-content-mode-after-applying-a-cifilter">http://stackoverflow.com/questions/15878060/setting-uiimageview-content-mode-after-applying-a-cifilter</a><br /></p><p>上面有说通过UIImage(CIImage:)方法得到的UIImage并不是一个基于CGImage的标准UIImage，所以不能按一般的显示规则去理解，因此我们要换种方式去得到一个真正的UIImage，解决方法放在下面再说。</p><p>在之前介绍CIImage和CIFilter的时候我们用到显式这个词，因为在代码里可以直观的看到使用了这两个类，CIImage提供图像的信息，CIFilter提供滤镜，当我们调用CIFilter的outputImage方法时，此时Core Image并不会去渲染图像，而是通过计算各种参数，并把计算结果存储到CIImage对象中，只有当真正将要显示的时候，才会通过第三个对象去渲染。这个对象就是<strong><span style="color:#cc0000;">CIContext</span></strong>。</p><p>CIContext是Core Image处理图像的关键，它和Core Graphics的CGContext类似但又与之不同，CIContext可以被重用，不必每次都新建一个，同时在输出CIImage的时候又必须有一个，简而言之，<strong><span style="color:#cc0000;">Core Image通过CIContext来渲染CIFilter产生的对象</span></strong>。</p><p>在上面的例子中我们没有使用CIContext，但在调用UIImage(CIImage:)的时候Core Image隐式地在内部使用了CIContext，也就是把我们需要手动做的工作自动地完成了。但是这就有了一个问题，在每次调用UIImage(CIImage:)的时候它都会重新创建一个CIContext对象，这在用完即毁的情况下不会造成很大的影响，但在反复地使用滤镜的过程中就很影响性能了，为了防止这种情况，我们把CIContext对象重用起来，让ViewController持有一个懒加载的属性：<span style="font-family: sans-serif; font-size: 16px;">&nbsp;</span></p><p></p><div style="font-family: sans-serif; font-size: 16px; margin: 10px 0px !important; line-height: 110% !important; background-color: rgb(248, 248, 255) !important; border: 1px solid rgba(0, 0, 0, 0.14902) !important; padding: 8.5px !important; border-top-left-radius: 4px !important; border-top-right-radius: 4px !important; border-bottom-right-radius: 4px !important; border-bottom-left-radius: 4px !important;"><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;"><span style="color: rgb(187, 44, 162);">lazy</span>&nbsp;<span style="color: rgb(187, 44, 162);">var</span>&nbsp;context:&nbsp;<span style="color: rgb(112, 61, 170);">CIContext</span>&nbsp;= {</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp;&nbsp;<span style="color: rgb(187, 44, 162);">return</span>&nbsp;<span style="color: rgb(112, 61, 170);">CIContext</span>(options:&nbsp;<span style="color: rgb(187, 44, 162);">nil</span>)</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">}()</p></div><p></p><p>CIContext在初始化的时候需要一个字典，可以通过kCIContextUseSoftwareRenderer创建一个基于CPU的CIContext对象，默认是创建基于GPU的CIContext对象，不同之处在于GPU的CIContext对象处理起来会更快，而基于CPU的CIContext对象除了支持更大的图像以外，还能在后台处理。我们传nil创建基于GPU的CIContext对象就可以了。</p><p><img src="https://img-blog.csdn.net/20140906182417521?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvemhhbmdhbzAwODY=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="" /><br /></p>有了可重用的CIContext对象，在创建UIImage的时候需要这样：<span style="font-family: sans-serif; font-size: 16px;">&nbsp;</span><p></p><div style="font-family: sans-serif; font-size: 16px; margin: 10px 0px !important; line-height: 110% !important; background-color: rgb(248, 248, 255) !important; border: 1px solid rgba(0, 0, 0, 0.14902) !important; padding: 8.5px !important; border-top-left-radius: 4px !important; border-top-right-radius: 4px !important; border-bottom-right-radius: 4px !important; border-bottom-left-radius: 4px !important;"><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;"><span style="color: rgb(187, 44, 162);">@IBAction</span>&nbsp;<span style="color: rgb(187, 44, 162);">func</span>&nbsp;autoAdjust() {</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp;&nbsp;<span style="color: rgb(187, 44, 162);">var</span>&nbsp;inputImage =&nbsp;<span style="color: rgb(112, 61, 170);">CIImage</span>(image:&nbsp;<span style="color: rgb(79, 129, 135);">originalImage</span>)</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp;&nbsp;<span style="color: rgb(187, 44, 162);">let</span>&nbsp;filters = inputImage.<span style="color: rgb(61, 29, 129);">autoAdjustmentFilters</span>()&nbsp;<span style="color: rgb(187, 44, 162);">as</span>&nbsp;[<span style="color: rgb(112, 61, 170);">CIFilter</span>]</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp;&nbsp;<span style="color: rgb(187, 44, 162);">for</span>&nbsp;filter:&nbsp;<span style="color: rgb(112, 61, 170);">CIFilter</span>&nbsp;<span style="color: rgb(187, 44, 162);">in</span>&nbsp;filters {</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp; &nbsp; &nbsp; filter.<span style="color: rgb(61, 29, 129);">setValue</span>(inputImage, forKey:&nbsp;<span style="color: rgb(112, 61, 170);">kCIInputImageKey</span>)</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp; &nbsp; &nbsp; inputImage = filter.<span style="color: rgb(112, 61, 170);">outputImage</span></p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp; }</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo; color: rgb(0, 132, 0);"><span style="color: rgb(0, 0, 0);">&nbsp; &nbsp;&nbsp;</span>//self.imageView.image = UIImage(CIImage: inputImage)</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp;&nbsp;<span style="color: rgb(187, 44, 162);">let</span>&nbsp;cgImage =&nbsp;<span style="color: rgb(79, 129, 135);">context</span>.<span style="color: rgb(61, 29, 129);">createCGImage</span>(inputImage, fromRect: inputImage.<span style="color: rgb(61, 29, 129);">extent</span>())</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp;&nbsp;<span style="color: rgb(187, 44, 162);">self</span>.<span style="color: rgb(79, 129, 135);">imageView</span>.<span style="color: rgb(112, 61, 170);">image</span>&nbsp;=&nbsp;<span style="color: rgb(112, 61, 170);">UIImage</span>(CGImage: cgImage)</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">}</p></div>虽然在第一次执行自动改善的时候会有点慢（因为要创建CIContext对象），但是在反复执行的情况下性能改善了很多，而且这样一来还解决了第二个问题，即ContentMode的问题。如果没有特殊情况，应该总是用这种方式创建一个CGImage，再把CGImage转成UIImage。<p><br /></p><h2>使用各种内置滤镜</h2><div>通过CIFilter的类方法<strong><span style="color:#cc0000;">filterNamesInCategory()</span></strong>可以得到属于某个类别下的所有滤镜：</div><div><div style="font-family: sans-serif; font-size: 16px; margin: 10px 0px !important; line-height: 110% !important; background-color: rgb(248, 248, 255) !important; border: 1px solid rgba(0, 0, 0, 0.14902) !important; padding: 8.5px !important; border-top-left-radius: 4px !important; border-top-right-radius: 4px !important; border-bottom-right-radius: 4px !important; border-bottom-left-radius: 4px !important;"><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;"><span style="color: rgb(187, 44, 162);">func</span>&nbsp;showFiltersInConsole() {</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo; color: rgb(112, 61, 170);"><span style="color: rgb(0, 0, 0);">&nbsp; &nbsp;&nbsp;</span><span style="color: rgb(187, 44, 162);">let</span><span style="color: rgb(0, 0, 0);">&nbsp;filterNames =&nbsp;</span>CIFilter<span style="color: rgb(0, 0, 0);">.</span><span style="color: rgb(61, 29, 129);">filterNamesInCategory</span><span style="color: rgb(0, 0, 0);">(</span>kCICategoryBuiltIn<span style="color: rgb(0, 0, 0);">)</span></p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp;&nbsp;<span style="color: rgb(61, 29, 129);">println</span>(filterNames.<span style="color: rgb(112, 61, 170);">count</span>)</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp;&nbsp;<span style="color: rgb(61, 29, 129);">println</span>(filterNames)</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp;&nbsp;<span style="color: rgb(187, 44, 162);">for</span>&nbsp;filterName&nbsp;<span style="color: rgb(187, 44, 162);">in</span>&nbsp;filterNames {</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<span style="color: rgb(187, 44, 162);">let</span>&nbsp;filter =&nbsp;<span style="color: rgb(112, 61, 170);">CIFilter</span>(name: filterName&nbsp;<span style="color: rgb(187, 44, 162);">as</span>&nbsp;<span style="color: rgb(112, 61, 170);">String</span>)</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<span style="color: rgb(187, 44, 162);">let</span>&nbsp;attributes = filter.<span style="color: rgb(61, 29, 129);">attributes</span>()</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<span style="color: rgb(61, 29, 129);">println</span>(attributes)</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp; }</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">}</p></div>在这个方法里传入的类别参数是<strong><span style="color:#cc0000;">kCICategoryBuiltIn</span></strong>，表示会输出iOS8 Core Image的所有滤镜：</div><div><img src="https://img-blog.csdn.net/20140906191145727?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvemhhbmdhbzAwODY=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="" /><br /></div><div>共有127种。当然了，并不是所有的滤镜都是常用的，我们可以通过<strong><span style="color:#cc0000;">kCICategoryColorEffect</span></strong>这个key取到一些常见的滤镜，就像iOS7相机应用里的一样，这些滤镜一般不需要设置什么参数（其中有些也可以设置不同的参数），只需要同上文一样，设置inputImage就行了。把这个类别下的滤镜打印一些出来看看：</div><div><img src="https://img-blog.csdn.net/20140906193244977?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvemhhbmdhbzAwODY=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="" /><br /></div><div>我选中了其中一个滤镜，这是一个单色滤镜，虽然看上去内容很多，但并不复杂，CIAttributeFilterDisplayName是它的显示名，inputImage是参数，每个参数的详细信息通过一个字典来展示，其中包括了这个参数的类型（CIAttributeTypeImage），以及参数的Class（CIImage），之后是这个滤镜所属的类别，一个滤镜可以同时属于多个类别，最后是这个滤镜在实例化的时候需要提供的字符串，即CIPhotoEffectMono。</div><div>它上面的CIPhotoEffectInstant以及下面的CIPhotoEffectNoir、CIPhotoEffectProcess与之类似，都只需要一个inputImage参数，是不是很简单？这些滤镜的参数已经被内部设置好了，我们直接使用即可。</div><div>为了方便使用，我们给ViewController持有一个CIFilter属性，在其他的方法中实例化CIFilter，同时用一个公共的方法来显示打上滤镜后的图像：</div><div><div style="font-family: sans-serif; font-size: 16px; margin: 10px 0px !important; line-height: 110% !important; background-color: rgb(248, 248, 255) !important; border: 1px solid rgba(0, 0, 0, 0.14902) !important; padding: 8.5px !important; border-top-left-radius: 4px !important; border-top-right-radius: 4px !important; border-bottom-right-radius: 4px !important; border-bottom-left-radius: 4px !important;"><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;"><span style="color: rgb(187, 44, 162);">class</span>&nbsp;ViewController:&nbsp;<span style="color: rgb(112, 61, 170);">UIViewController</span>&nbsp;{</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp;&nbsp;<span style="color: rgb(187, 44, 162);">@IBOutlet</span>&nbsp;<span style="color: rgb(187, 44, 162);">var</span>&nbsp;imageView:&nbsp;<span style="color: rgb(112, 61, 170);">UIImageView</span>!</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo; min-height: 13px;">&nbsp;&nbsp; &nbsp;</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp;&nbsp;<span style="color: rgb(187, 44, 162);">lazy</span>&nbsp;<span style="color: rgb(187, 44, 162);">var</span>&nbsp;originalImage:&nbsp;<span style="color: rgb(112, 61, 170);">UIImage</span>&nbsp;= {</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<span style="color: rgb(187, 44, 162);">return</span>&nbsp;<span style="color: rgb(112, 61, 170);">UIImage</span>(named:&nbsp;<span style="color: rgb(209, 47, 27);">&quot;Image&quot;</span>)</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp; }()</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp;&nbsp;<span style="color: rgb(187, 44, 162);">lazy</span>&nbsp;<span style="color: rgb(187, 44, 162);">var</span>&nbsp;context:&nbsp;<span style="color: rgb(112, 61, 170);">CIContext</span>&nbsp;= {</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<span style="color: rgb(187, 44, 162);">return</span>&nbsp;<span style="color: rgb(112, 61, 170);">CIContext</span>(options:&nbsp;<span style="color: rgb(187, 44, 162);">nil</span>)</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp; }()</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp;&nbsp;<span style="color: rgb(187, 44, 162);">var</span>&nbsp;filter:&nbsp;<span style="color: rgb(112, 61, 170);">CIFilter</span>!</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">......</p></div><div style="font-family: sans-serif; font-size: 16px; margin: 10px 0px !important; line-height: 110% !important; background-color: rgb(248, 248, 255) !important; border: 1px solid rgba(0, 0, 0, 0.14902) !important; padding: 8.5px !important; border-top-left-radius: 4px !important; border-top-right-radius: 4px !important; border-bottom-right-radius: 4px !important; border-bottom-left-radius: 4px !important;"><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo; color: rgb(0, 132, 0);">// MARK: -&nbsp;<span style="font-family: 'Heiti SC Light';">怀旧</span></p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;"><span style="color: rgb(187, 44, 162);">@IBAction</span>&nbsp;<span style="color: rgb(187, 44, 162);">func</span>&nbsp;photoEffectInstant() {</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo; color: rgb(209, 47, 27);"><span style="color: rgb(0, 0, 0);">&nbsp; &nbsp;&nbsp;</span><span style="color: rgb(79, 129, 135);">filter</span><span style="color: rgb(0, 0, 0);">&nbsp;=&nbsp;</span><span style="color: rgb(112, 61, 170);">CIFilter</span><span style="color: rgb(0, 0, 0);">(name:&nbsp;</span>&quot;CIPhotoEffectInstant&quot;<span style="color: rgb(0, 0, 0);">)</span></p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo; color: rgb(49, 89, 93);"><span style="color: rgb(0, 0, 0);">&nbsp; &nbsp;&nbsp;</span>outputImage<span style="color: rgb(0, 0, 0);">()</span></p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">}</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo; color: rgb(0, 132, 0);">// MARK: -&nbsp;<span style="font-family: 'Heiti SC Light';">黑白</span></p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;"><span style="color: rgb(187, 44, 162);">@IBAction</span>&nbsp;<span style="color: rgb(187, 44, 162);">func</span>&nbsp;photoEffectNoir() {</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo; color: rgb(209, 47, 27);"><span style="color: rgb(0, 0, 0);">&nbsp; &nbsp;&nbsp;</span><span style="color: rgb(79, 129, 135);">filter</span><span style="color: rgb(0, 0, 0);">&nbsp;=&nbsp;</span><span style="color: rgb(112, 61, 170);">CIFilter</span><span style="color: rgb(0, 0, 0);">(name:&nbsp;</span>&quot;CIPhotoEffectNoir&quot;<span style="color: rgb(0, 0, 0);">)</span></p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo; color: rgb(49, 89, 93);"><span style="color: rgb(0, 0, 0);">&nbsp; &nbsp;&nbsp;</span>outputImage<span style="color: rgb(0, 0, 0);">()</span></p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">}</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo; color: rgb(0, 132, 0);">// MARK: -&nbsp;<span style="font-family: 'Heiti SC Light';">色调</span></p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;"><span style="color: rgb(187, 44, 162);">@IBAction</span>&nbsp;<span style="color: rgb(187, 44, 162);">func</span>&nbsp;photoEffectTonal() {</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo; color: rgb(209, 47, 27);"><span style="color: rgb(0, 0, 0);">&nbsp; &nbsp;&nbsp;</span><span style="color: rgb(79, 129, 135);">filter</span><span style="color: rgb(0, 0, 0);">&nbsp;=&nbsp;</span><span style="color: rgb(112, 61, 170);">CIFilter</span><span style="color: rgb(0, 0, 0);">(name:&nbsp;</span>&quot;CIPhotoEffectTonal&quot;<span style="color: rgb(0, 0, 0);">)</span></p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo; color: rgb(49, 89, 93);"><span style="color: rgb(0, 0, 0);">&nbsp; &nbsp;&nbsp;</span>outputImage<span style="color: rgb(0, 0, 0);">()</span></p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">}</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo; color: rgb(0, 132, 0);">// MARK: -&nbsp;<span style="font-family: 'Heiti SC Light';">岁月</span></p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;"><span style="color: rgb(187, 44, 162);">@IBAction</span>&nbsp;<span style="color: rgb(187, 44, 162);">func</span>&nbsp;photoEffectTransfer() {</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo; color: rgb(209, 47, 27);"><span style="color: rgb(0, 0, 0);">&nbsp; &nbsp;&nbsp;</span><span style="color: rgb(79, 129, 135);">filter</span><span style="color: rgb(0, 0, 0);">&nbsp;=&nbsp;</span><span style="color: rgb(112, 61, 170);">CIFilter</span><span style="color: rgb(0, 0, 0);">(name:&nbsp;</span>&quot;CIPhotoEffectTransfer&quot;<span style="color: rgb(0, 0, 0);">)</span></p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo; color: rgb(49, 89, 93);"><span style="color: rgb(0, 0, 0);">&nbsp; &nbsp;&nbsp;</span>outputImage<span style="color: rgb(0, 0, 0);">()</span></p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">}</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo; color: rgb(0, 132, 0);">// MARK: -&nbsp;<span style="font-family: 'Heiti SC Light';">单色</span></p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;"><span style="color: rgb(187, 44, 162);">@IBAction</span>&nbsp;<span style="color: rgb(187, 44, 162);">func</span>&nbsp;photoEffectMono() {</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo; color: rgb(209, 47, 27);"><span style="color: rgb(0, 0, 0);">&nbsp; &nbsp;&nbsp;</span><span style="color: rgb(79, 129, 135);">filter</span><span style="color: rgb(0, 0, 0);">&nbsp;=&nbsp;</span><span style="color: rgb(112, 61, 170);">CIFilter</span><span style="color: rgb(0, 0, 0);">(name:&nbsp;</span>&quot;CIPhotoEffectMono&quot;<span style="color: rgb(0, 0, 0);">)</span></p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo; color: rgb(49, 89, 93);"><span style="color: rgb(0, 0, 0);">&nbsp; &nbsp;&nbsp;</span>outputImage<span style="color: rgb(0, 0, 0);">()</span></p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">}</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo; color: rgb(0, 132, 0);">// MARK: -&nbsp;<span style="font-family: 'Heiti SC Light';">褪色</span></p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;"><span style="color: rgb(187, 44, 162);">@IBAction</span>&nbsp;<span style="color: rgb(187, 44, 162);">func</span>&nbsp;photoEffectFade() {</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo; color: rgb(209, 47, 27);"><span style="color: rgb(0, 0, 0);">&nbsp; &nbsp;&nbsp;</span><span style="color: rgb(79, 129, 135);">filter</span><span style="color: rgb(0, 0, 0);">&nbsp;=&nbsp;</span><span style="color: rgb(112, 61, 170);">CIFilter</span><span style="color: rgb(0, 0, 0);">(name:&nbsp;</span>&quot;CIPhotoEffectFade&quot;<span style="color: rgb(0, 0, 0);">)</span></p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo; color: rgb(49, 89, 93);"><span style="color: rgb(0, 0, 0);">&nbsp; &nbsp;&nbsp;</span>outputImage<span style="color: rgb(0, 0, 0);">()</span></p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">}</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo; color: rgb(0, 132, 0);">// MARK: -&nbsp;<span style="font-family: 'Heiti SC Light';">冲印</span></p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;"><span style="color: rgb(187, 44, 162);">@IBAction</span>&nbsp;<span style="color: rgb(187, 44, 162);">func</span>&nbsp;photoEffectProcess() {</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo; color: rgb(209, 47, 27);"><span style="color: rgb(0, 0, 0);">&nbsp; &nbsp;&nbsp;</span><span style="color: rgb(79, 129, 135);">filter</span><span style="color: rgb(0, 0, 0);">&nbsp;=&nbsp;</span><span style="color: rgb(112, 61, 170);">CIFilter</span><span style="color: rgb(0, 0, 0);">(name:&nbsp;</span>&quot;CIPhotoEffectProcess&quot;<span style="color: rgb(0, 0, 0);">)</span></p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo; color: rgb(49, 89, 93);"><span style="color: rgb(0, 0, 0);">&nbsp; &nbsp;&nbsp;</span>outputImage<span style="color: rgb(0, 0, 0);">()</span></p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">}</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo; color: rgb(0, 132, 0);">// MARK: -&nbsp;<span style="font-family: 'Heiti SC Light';">铬黄</span></p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;"><span style="color: rgb(187, 44, 162);">@IBAction</span>&nbsp;<span style="color: rgb(187, 44, 162);">func</span>&nbsp;photoEffectChrome() {</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo; color: rgb(209, 47, 27);"><span style="color: rgb(0, 0, 0);">&nbsp; &nbsp;&nbsp;</span><span style="color: rgb(79, 129, 135);">filter</span><span style="color: rgb(0, 0, 0);">&nbsp;=&nbsp;</span><span style="color: rgb(112, 61, 170);">CIFilter</span><span style="color: rgb(0, 0, 0);">(name:&nbsp;</span>&quot;CIPhotoEffectChrome&quot;<span style="color: rgb(0, 0, 0);">)</span></p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo; color: rgb(49, 89, 93);"><span style="color: rgb(0, 0, 0);">&nbsp; &nbsp;&nbsp;</span>outputImage<span style="color: rgb(0, 0, 0);">()</span></p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">}<span style="font-family: sans-serif; font-size: 16px;">&nbsp;</span></p></div></div><div style="font-family: sans-serif; font-size: 16px; margin: 10px 0px !important; line-height: 110% !important; background-color: rgb(248, 248, 255) !important; border: 1px solid rgba(0, 0, 0, 0.14902) !important; padding: 8.5px !important; border-top-left-radius: 4px !important; border-top-right-radius: 4px !important; border-bottom-right-radius: 4px !important; border-bottom-left-radius: 4px !important;"><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;"><span style="color: rgb(187, 44, 162);">func</span>&nbsp;outputImage() {</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo; color: rgb(61, 29, 129);"><span style="color: rgb(0, 0, 0);">&nbsp; &nbsp;&nbsp;</span>println<span style="color: rgb(0, 0, 0);">(</span><span style="color: rgb(79, 129, 135);">filter</span><span style="color: rgb(0, 0, 0);">)</span></p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp;&nbsp;<span style="color: rgb(187, 44, 162);">let</span>&nbsp;inputImage =&nbsp;<span style="color: rgb(112, 61, 170);">CIImage</span>(image:&nbsp;<span style="color: rgb(79, 129, 135);">originalImage</span>)</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp;&nbsp;<span style="color: rgb(79, 129, 135);">filter</span>.<span style="color: rgb(61, 29, 129);">setValue</span>(inputImage, forKey:&nbsp;<span style="color: rgb(112, 61, 170);">kCIInputImageKey</span>)</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp;&nbsp;<span style="color: rgb(187, 44, 162);">let</span>&nbsp;outputImage =&nbsp;&nbsp;<span style="color: rgb(79, 129, 135);">filter</span>.<span style="color: rgb(112, 61, 170);">outputImage</span></p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp;&nbsp;<span style="color: rgb(187, 44, 162);">let</span>&nbsp;cgImage =&nbsp;<span style="color: rgb(79, 129, 135);">context</span>.<span style="color: rgb(61, 29, 129);">createCGImage</span>(outputImage, fromRect: outputImage.<span style="color: rgb(61, 29, 129);">extent</span>())</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp;&nbsp;<span style="color: rgb(187, 44, 162);">self</span>.<span style="color: rgb(79, 129, 135);">imageView</span>.<span style="color: rgb(112, 61, 170);">image</span>&nbsp;=&nbsp;<span style="color: rgb(112, 61, 170);">UIImage</span>(CGImage: cgImage)</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">}</p></div><p>这些都写好后，在UI上把各种按钮及touch事件绑定好，UI看起来像这样：</p><p><img src="https://img-blog.csdn.net/20140906224510718?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvemhhbmdhbzAwODY=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="" /><br /></p><p>运行后各种滤镜效果：</p><p><img src="https://img-blog.csdn.net/20140906230757765?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvemhhbmdhbzAwODY=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="" /><br /></p><p>以上就是对Core Image内置滤镜的简单使用，如果你不需要对滤镜做更加细粒度控制的话，上述方法就够用了。</p><p><br /></p><h2><a target=_blank target="_blank" href="https://github.com/zhangao0086/iOS-CoreImage-Swift">GitHub下载地址</a></h2><div>我在GitHub上会保持更新。</div><p><br /></p><h2><span style="color:#cc0000;">UPDATED:</span></h2><div>另外不知道有没有人注意到我在注释里用到了<strong><span style="color:#cc0000;">// MARK: -</span></strong>，这和Objective-C的<strong><span style="color:#cc0000;">#pragma mark -</span></strong>作用一样。</div><div><br /></div><p><br /></p><p>参考资料：</p><p><a target=_blank target="_blank" href="https://developer.apple.com/library/mac/documentation/graphicsimaging/conceptual/CoreImaging/ci_intro/ci_intro.html">https://developer.apple.com/library/mac/documentation/graphicsimaging/conceptual/CoreImaging/ci_intro/ci_intro.html</a><br /></p>