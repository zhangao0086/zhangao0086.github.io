---
layout: post
title: 'jBPM一(概念及管理控制流程)'
date: 2011-04-15 21:51:00 +0800
categories: [Java]
csdn_read_num: 8987
article_type: 1
---


<p>工作流（Workflow），就是“业务过程的部分或整体在计算机应用环境下的自动化”，它主要解决的是“使在多个参与者之间按照某种预定义的规则传递文档、信息或任务的过程自动进行，从而实现某个预期的业务目标，或者促使此目标的实现”。  </p><p>通俗的说，流程就是多个人在一起合作完成某件事情的必要步骤，把步骤变成计算机能理解的形式就是工作流。</p><p>工作流管理系统（WfMS，Workflow Management System）的主要功能是通过计算机技术的支持去定义、执行和管理工作流，协调工作流执行过程中，工作之间以及群体成员之间的信息交互。工作流需要依靠工作流管理系统来实现。工作流管理系统是定义、创建、执行工作流的系统，应能提供以下三个方面的功能支持：  </p><ol><li>定义工作流：包括具体的活动、规则等  </li><li>运行控制功能：在运行环境中管理工作流过程，对工作流过程中的活动进行调度  </li><li>运行交互功能：指在工作流运行中，WfMS与用户（活动的参与者）及外部应用程序工具交互的功能。</li></ol><p>那么使用工作流管理系统有什么好处呢?</p><ol><li>提高系统的柔性,适应业务流程的变化.  </li><li>实现更好的业务过程控制,提高顾客服务质量  </li><li>降低系统开发和维护成本</li></ol><p>目前市面上主要的工作流框架有:Jbpm、OSWorkflow、ActiveBPEL、YAWL等.</p><p>一个工作流管理系统往往分为两部分组成,定义工作流的时候，需要给用户提供一种简单清晰的方案，一般提供给一个&quot;流程设计器&quot;来帮助用户有效的制定流程.我们无法让计算机依客户的方案去执行这套流程,我们必须要使用计算机能够读得懂的语言.xml能够很好的描述数据之间的关系,jBPM就对xml提供了约束文档,称为JPDL(jBPM Process Definition Language).在客户制定流程的时候,要生成一张图片给客户看,还要生成一个xml文件给计算机看.因为我们不知道客户需要什么样的流程,而且流程要给客户自由管理,比如添加一个流程,或是删除一个流程,所以这是客户需要做的,这被称为<strong><span style="color: #ff0000;">表达业务流程</span></strong>.我们需要做的就是让工作流系统正确的工作,<strong><span style="color: #ff0000;">管理控制流程</span></strong>,大致上可以分为这个两部分:<br /><br /><a target=_blank href="http://hi.csdn.net/attachment/201104/15/0_130287548986j8.gif"><img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" src="http://hi.csdn.net/attachment/201104/15/0_1302875494gRTZ.gif" border="0" alt="image" width="948" height="340" /></a></p><p>jBPM也是使用Hibernate对流程的数据进行存储,它将在数据库中创建18张表来管理不同的信息.如果数据库是Mysql,则方言一定要是<strong><span style="color: red;">MySQL5InnoDBDialect!</span></strong></p><p>在Eclipse中安装完插件(GPD)后,就能使用流程设计器了.</p><p><a target=_blank href="http://hi.csdn.net/attachment/201104/15/0_13028754987F59.gif"><img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" src="http://hi.csdn.net/attachment/201104/15/0_1302875500k55e.gif" border="0" alt="image" width="317" height="267" /></a></p><p>在保存的时候将同步生成一个对应的xml文件.这个xml文件是最主要的文件.</p><h4><span style="font-weight: normal;font-size:14px;">相关概念:<br /></span></h4><p><strong>Process definition---流程定义</strong></p><p>流程定义就是整个流程的一个描述.</p><p><strong>Process instance---流程实例</strong></p><p>一个流程实例包括了所有运行阶段， 其中最典型的属性就是跟踪当前节点的指针。它就是一个主线.  </p><p><strong>Execution---执行</strong>  </p><p>一般情况下，一个流程实例是一个执行树的根节点， 当一个新的流程实例启动时，实际上流程实例就处于根节点的位置， 这时只有它的&quot;子节点&quot;才可以被激活。使用树状结构的原因在于， 这一概念只有一条执行路径， 使用起来更简单。 业务API不需要了解流程实例和执行之间功能的区别。 因此， API里只有一个执行类型来引用流程实例和执行。它相当于一个支线.  </p><p>ProcessEngine最核心的对象,就像Hibernate中的SessionFactory一样,做任何事情都要通过它.ProcessEngine提供了获取Service的方法,以下是获取Service的方式:  </p><blockquote><p><strong>RepositoryService</strong> repositoryService = processEngine.getRepositoryService();  </p><p><strong>ExecutionService</strong> executionService = processEngine.getExecutionService();  </p><p><strong>TaskService</strong> taskService = processEngine.getTaskService();  </p><p><strong>HistoryService</strong> historyService = processEngine.getHistoryService();  </p><p><strong>ManagementService</strong> managementService = processEngine.getManagementService();  </p><p><strong>IdentityService </strong>identityService = processEngine.getIdentityService();</p></blockquote><p>各个Service的作用：</p><table border="1" cellspacing="0" cellpadding="0"><tbody><tr><td width="169" valign="top"><p><strong>RepositoryService</strong></p></td><td width="402" valign="top"><p><strong>管理流程定义</strong></p></td></tr><tr><td width="169" valign="top"><p><strong>ExecutionService</strong></p></td><td width="402" valign="top"><p><strong>执行管理，包括启动、推进、删除流程实例等操作</strong></p></td></tr><tr><td width="169" valign="top"><p><strong>TaskService</strong></p></td><td width="402" valign="top"><p><strong>任务管理</strong></p></td></tr><tr><td width="169" valign="top"><p>HistoryService</p></td><td width="402" valign="top"><p>历史管理（执行完的数据管理）</p></td></tr><tr><td width="169" valign="top"><p>IdentityService</p></td><td width="402" valign="top"><p>jBPM的用户、组管理</p></td></tr><tr><td width="169" valign="top"><p>ManagementService</p></td><td width="402" valign="top">&nbsp;</td></tr></tbody></table><p>有关查询的API:</p><table border="1" cellspacing="0" cellpadding="0"><tbody><tr><td width="127" valign="top"><p><strong>功能说明</strong></p></td><td width="489" valign="top"><p><strong>相应的查询API</strong></p></td></tr><tr><td width="127" valign="top"><p>查询“流程定义”</p></td><td width="489" valign="top"><p><strong>ProcessDefinitionQuery</strong> <span style="text-decoration: underline;">processDefinitionQuery</span> =  </p><p>processEngine.getRepositoryService()  </p><p>.createProcessDefinitionQuery();</p></td></tr><tr><td width="127" valign="top"><p>查询“执行对象”  </p><p>（流程实例）</p></td><td width="489" valign="top"><p><strong>ProcessInstanceQuery</strong> <span style="text-decoration: underline;">processInstanceQuery</span> =  </p><p>processEngine.getExecutionService() //  </p><p>.createProcessInstanceQuery();</p></td></tr><tr><td width="127" valign="top"><p>查询“任务”</p></td><td width="489" valign="top"><p><strong>TaskQuery</strong> <span style="text-decoration: underline;">taskQuery</span> = //  </p><p>processEngine.getTaskService()//  </p><p>.createTaskQuery();</p></td></tr><tr><td width="127" valign="top"><p>查询“执行历史”  </p><p>（流程实例历史）</p></td><td width="489" valign="top"><p><strong>HistoryProcessInstanceQuery</strong> <span style="text-decoration: underline;">historyProcessInstanceQuery</span> =  </p><p>processEngine.getHistoryService()  </p><p>.createHistoryProcessInstanceQuery();</p></td></tr><tr><td width="127" valign="top"><p>查询“任务历史”</p></td><td width="489" valign="top"><p><strong>HistoryTaskQuery</strong> <span style="text-decoration: underline;">historyTaskQuery</span> =  </p><p>processEngine.getHistoryService()  </p><p>.createHistoryTaskQuery();</p></td></tr></tbody></table><p>jBPM的API风格都是<strong>方法调用链</strong>的形式.</p><p><strong>创建一个流程定义</strong></p><p>被添加的文件可以是一个文件:</p><div id="codeSnippetWrapper" style="text-align: left; line-height: 12pt; background-color: #f4f4f4; margin: 20px 0px 10px; width: 99%; font-family: 'Courier New', courier, monospace; direction: ltr; font-size: 10pt; overflow: auto; cursor: text; border: silver 1px solid; padding: 4px;"><div id="codeSnippet" style="text-align: left; line-height: 12pt; background-color: #f4f4f4; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;"><pre style="text-align: left; line-height: 12pt; background-color: white; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;"><span style="color: #0000ff">private</span> ProcessEngine processEngine = Configuration.getProcessEngine();</pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: #f4f4f4; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">&nbsp;</pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: white; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;"><span style="color: #008000">// 部署（添加）</span></pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: #f4f4f4; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;"><span style="color: #008000">// jbpm4_deployment, jbpm4_deployprop, jbpm4_lob</span></pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: white; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">@Test</pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: #f4f4f4; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;"><span style="color: #0000ff">public</span> <span style="color: #0000ff">void</span> deploy() {</pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: white; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">    String deploymentId = processEngine.getRepositoryService()<span style="color: #008000">//</span></pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: #f4f4f4; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">            .createDeployment()<span style="color: #008000">//</span></pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: white; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">            .addResourceFromClasspath(<span style="color: #006080">&quot;aa/aa.jpdl.xml&quot;</span>)<span style="color: #008000">// 必须要有一个 .jpdl.xml 文件</span></pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: #f4f4f4; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">            .addResourceFromClasspath(<span style="color: #006080">&quot;aa/aa.png&quot;</span>)<span style="color: #008000">//</span></pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: white; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">            .deploy();</pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: #f4f4f4; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">    System.out.println(<span style="color: #006080">&quot;部署成功，deploymentId = &quot;</span> + deploymentId);</pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: white; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">}</pre><!--CRLF--></div></div><p>也可以是一组文件(Zip):</p><div id="codeSnippetWrapper" style="text-align: left; line-height: 12pt; background-color: #f4f4f4; margin: 20px 0px 10px; width: 99%; font-family: 'Courier New', courier, monospace; direction: ltr; font-size: 10pt; overflow: auto; cursor: text; border: silver 1px solid; padding: 4px;"><div id="codeSnippet" style="text-align: left; line-height: 12pt; background-color: #f4f4f4; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;"><pre style="text-align: left; line-height: 12pt; background-color: white; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;"><span style="color: #008000">/**</span></pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: #f4f4f4; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;"><span style="color: #008000"> * 创建一个流程定义</span></pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: white; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;"><span style="color: #008000"> */</span></pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: #f4f4f4; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">@Test</pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: white; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;"><span style="color: #0000ff">public</span> <span style="color: #0000ff">void</span> createProcessDefinition() {</pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: #f4f4f4; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">    <span style="color: #008000">//获取当前类路径下的文件</span></pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: white; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">    ZipInputStream in = <span style="color: #0000ff">new</span> ZipInputStream(CRD.<span style="color: #0000ff">class</span>.getClassLoader()</pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: #f4f4f4; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">            .getResourceAsStream(<span style="color: #006080">&quot;JBPM.zip&quot;</span>));</pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: white; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">&nbsp;</pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: #f4f4f4; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">    processEngine.getRepositoryService()<span style="color: #008000">//</span></pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: white; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">            .createDeployment()<span style="color: #008000">//</span></pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: #f4f4f4; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">            .addResourcesFromZipInputStream(in)<span style="color: #008000">//</span></pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: white; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">            .deploy();</pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: #f4f4f4; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">}</pre><!--CRLF--></div></div><p>推荐使<strong><span style="color: #ff0000;">用Zip文件</span></strong>的形式.</p><p><strong>查询所有的流程定义</strong></p><div id="codeSnippetWrapper" style="text-align: left; line-height: 12pt; background-color: #f4f4f4; margin: 20px 0px 10px; width: 99%; font-family: 'Courier New', courier, monospace; direction: ltr; font-size: 10pt; overflow: auto; cursor: text; border: silver 1px solid; padding: 4px;"><div id="codeSnippet" style="text-align: left; line-height: 12pt; background-color: #f4f4f4; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;"><pre style="text-align: left; line-height: 12pt; background-color: white; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;"><span style="color: #008000">// Deployment：一次部署的信息（包含多个文件）。</span></pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: #f4f4f4; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;"><span style="color: #008000">// ProcessDefinition（流程定义）：是指解析xx.jpdl.xml后得到的流程信息。</span></pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: white; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">@Test</pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: #f4f4f4; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;"><span style="color: #0000ff">public</span> <span style="color: #0000ff">void</span> findAll() {</pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: white; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">    <span style="color: #008000">// 查询</span></pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: #f4f4f4; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">    List list = processEngine.getRepositoryService()<span style="color: #008000">//</span></pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: white; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">            .createProcessDefinitionQuery()<span style="color: #008000">//</span></pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: #f4f4f4; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">            .list();</pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: white; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">&nbsp;</pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: #f4f4f4; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">    <span style="color: #008000">// 显示</span></pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: white; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">    <span style="color: #0000ff">for</span> (ProcessDefinition pd : list) {</pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: #f4f4f4; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">        System.out.println(<span style="color: #006080">&quot;id=&quot;</span> + pd.getId()<span style="color: #008000">// 格式为：{key}-{version}</span></pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: white; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">                + <span style="color: #006080">&quot;, name=&quot;</span> + pd.getName()<span style="color: #008000">// .jpdl.xml中根元素的name属性的值</span></pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: #f4f4f4; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">                + <span style="color: #006080">&quot;, key=&quot;</span> + pd.getKey()<span style="color: #008000">// .jpdl.xml中根元素的key属性的值，如果没有指定，默认为name属性的值 。</span></pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: white; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">                + <span style="color: #006080">&quot;, version=&quot;</span> + pd.getVersion()<span style="color: #008000">// 版本，默认是1，或自动累加。</span></pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: #f4f4f4; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">                + <span style="color: #006080">&quot;, deploymentId=&quot;</span> + pd.getDeploymentId()); <span style="color: #008000">// 所属的Deployment记录的id</span></pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: white; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">    }</pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: #f4f4f4; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">}</pre><!--CRLF--></div></div><p>jBPM不支持已经部署的流程定义,这也是不能提供的操作,试想几种情况之后就不能发现这是很明智的选择:如果当前有流程实例,原流程有5个步骤要去,走到一半,流程被修改成了7个步骤,中间的活动可能已经被改变了,那么就可能出现问题;或者走到了第4步的时候,流程被修改成了只有3步,那怎么办?所以不支持修改流程定义不仅没有对工作造成影响,还很大程度地保障了原先流程实例的正确执行,以及不对历史中的流程实例造成影响.</p><p>只能重新部署一个流程,如果和已有的流程的名字有冲突,将自动把版本号加1,以视区别.在这种情况下,就要保证以后开始的流程实例都是最新的流程实例.</p><p><strong>查询所有最新版本的流程定义</strong></p><div id="codeSnippetWrapper" style="text-align: left; line-height: 12pt; background-color: #f4f4f4; margin: 20px 0px 10px; width: 99%; font-family: 'Courier New', courier, monospace; direction: ltr; font-size: 10pt; overflow: auto; cursor: text; border: silver 1px solid; padding: 4px;"><div id="codeSnippet" style="text-align: left; line-height: 12pt; background-color: #f4f4f4; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;"><pre style="text-align: left; line-height: 12pt; background-color: white; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;"><span style="color: #008000">// OrderBy的属性名在ProcessDefinitionQuery中有常量的定义。</span></pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: #f4f4f4; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">@Test</pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: white; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;"><span style="color: #0000ff">public</span> <span style="color: #0000ff">void</span> findAllLatestVersions() {</pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: #f4f4f4; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">    <span style="color: #008000">// 1，查询所有的流程定义</span></pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: white; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">    <span style="color: #008000">// 按version排序，以便让所有最大的版本都排在最后面</span></pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: #f4f4f4; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">    List allList = processEngine.getRepositoryService()<span style="color: #008000">//</span></pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: white; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">            .createProcessDefinitionQuery()<span style="color: #008000">//</span></pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: #f4f4f4; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">            .orderAsc(ProcessDefinitionQuery.PROPERTY_VERSION)<span style="color: #008000">//</span></pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: white; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">            .list();</pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: #f4f4f4; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">    <span style="color: #008000">// 2，过滤出所需的最新版本流程定义的集合</span></pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: white; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">    Map map = <span style="color: #0000ff">new</span> HashMap();</pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: #f4f4f4; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">    <span style="color: #0000ff">for</span> (ProcessDefinition pd : allList) {</pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: white; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">        <span style="color: #008000">// ProcessDefinition pdInMap = map.get(pd.getKey());</span></pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: #f4f4f4; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">        <span style="color: #008000">// if(pdInMap == null || pdInMap.getVersion() &lt; pd.getVersion()){</span></pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: white; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">        <span style="color: #008000">// map.put(pd.getKey(), pd);</span></pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: #f4f4f4; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">        <span style="color: #008000">// }</span></pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: white; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">        map.put(pd.getKey(), pd);</pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: #f4f4f4; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">    }</pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: white; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">&nbsp;</pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: #f4f4f4; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">    <span style="color: #008000">// 显示</span></pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: white; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">    <span style="color: #0000ff">for</span> (ProcessDefinition pd : map.values()) {</pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: #f4f4f4; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">        System.out.println(<span style="color: #006080">&quot;id=&quot;</span> + pd.getId()<span style="color: #008000">// 格式为：{key}-{version}</span></pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: white; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">                + <span style="color: #006080">&quot;, name=&quot;</span> + pd.getName()<span style="color: #008000">// .jpdl.xml中根元素的name属性的值</span></pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: #f4f4f4; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">                + <span style="color: #006080">&quot;, key=&quot;</span> + pd.getKey()<span style="color: #008000">// .jpdl.xml中根元素的key属性的值，如果没有指定，默认为name属性的值 。</span></pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: white; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">                + <span style="color: #006080">&quot;, version=&quot;</span> + pd.getVersion()<span style="color: #008000">// 版本，默认是1，或自动累加。</span></pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: #f4f4f4; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">                + <span style="color: #006080">&quot;, deploymentId=&quot;</span> + pd.getDeploymentId()); <span style="color: #008000">// 所属的Deployment记录的id</span></pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: white; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">    }</pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: #f4f4f4; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">}</pre><!--CRLF--></div></div><p>由于没有直接查询最新流程定义的语法,所以只能先全部查出,再进行筛选.上面的代码使用了两种方法,第一种(被注释的)每次都判断一下,以保证新的流程定义不被旧的覆盖;第二种在查询时增加了排序条件,保证新的流程定义都在后面,所以不用判断.</p><p><strong>删除一个Deployment</strong></p><div id="codeSnippetWrapper" style="text-align: left; line-height: 12pt; background-color: #f4f4f4; margin: 20px 0px 10px; width: 99%; font-family: 'Courier New', courier, monospace; direction: ltr; font-size: 10pt; overflow: auto; cursor: text; border: silver 1px solid; padding: 4px;"><div id="codeSnippet" style="text-align: left; line-height: 12pt; background-color: #f4f4f4; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;"><pre style="text-align: left; line-height: 12pt; background-color: white; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">@Test</pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: #f4f4f4; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;"><span style="color: #0000ff">public</span> <span style="color: #0000ff">void</span> deleteById() {</pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: white; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">    String deploymentId = <span style="color: #006080">&quot;40001&quot;</span>;</pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: #f4f4f4; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">&nbsp;</pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: white; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">    <span style="color: #008000">// // 删除一次部署的信息（删除相关的文件），如果有相关的运行信息，则报错</span></pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: #f4f4f4; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">    <span style="color: #008000">// processEngine.getRepositoryService().deleteDeployment(deploymentId);</span></pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: white; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">&nbsp;</pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: #f4f4f4; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">    <span style="color: #008000">// 删除一次部署的信息（删除相关的文件），会级联删除所有相关的运行信息</span></pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: white; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">    processEngine.getRepositoryService().deleteDeploymentCascade(deploymentId);</pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: #f4f4f4; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">}</pre><!--CRLF--></div></div><p><strong>删除指定key的所有版本的流程定义（所属的Deployment）</strong></p><div id="codeSnippetWrapper" style="text-align: left; line-height: 12pt; background-color: #f4f4f4; margin: 20px 0px 10px; width: 99%; font-family: 'Courier New', courier, monospace; direction: ltr; font-size: 10pt; overflow: auto; cursor: text; border: silver 1px solid; padding: 4px;"><div id="codeSnippet" style="text-align: left; line-height: 12pt; background-color: #f4f4f4; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;"><pre style="text-align: left; line-height: 12pt; background-color: white; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">@Test</pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: #f4f4f4; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;"><span style="color: #0000ff">public</span> <span style="color: #0000ff">void</span> deleteByKey() {</pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: white; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">    <span style="color: #008000">// 1，查询出指定key的所有版本的流程定义</span></pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: #f4f4f4; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">    String key = <span style="color: #006080">&quot;test&quot;</span>;</pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: white; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">    List list = processEngine.getRepositoryService()<span style="color: #008000">//</span></pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: #f4f4f4; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">            .createProcessDefinitionQuery()<span style="color: #008000">//</span></pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: white; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">            .processDefinitionKey(key)<span style="color: #008000">//</span></pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: #f4f4f4; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">            .list();</pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: white; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">&nbsp;</pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: #f4f4f4; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">    <span style="color: #008000">// 2，循环删除</span></pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: white; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">    <span style="color: #0000ff">for</span> (ProcessDefinition pd : list) {</pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: #f4f4f4; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">        processEngine.getRepositoryService().deleteDeploymentCascade(pd.getDeploymentId());</pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: white; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">    }</pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: #f4f4f4; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">}</pre><!--CRLF--></div></div><p><strong><br />查看流程图</strong></p><div id="codeSnippetWrapper" style="text-align: left; line-height: 12pt; background-color: #f4f4f4; margin: 20px 0px 10px; width: 99%; font-family: 'Courier New', courier, monospace; direction: ltr; font-size: 10pt; overflow: auto; cursor: text; border: silver 1px solid; padding: 4px;"><div id="codeSnippet" style="text-align: left; line-height: 12pt; background-color: #f4f4f4; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;"><pre style="text-align: left; line-height: 12pt; background-color: white; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">@Test</pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: #f4f4f4; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;"><span style="color: #0000ff">public</span> <span style="color: #0000ff">void</span> getProcessImage() <span style="color: #0000ff">throws</span> Exception {</pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: white; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">    String deploymentId = <span style="color: #006080">&quot;60001&quot;</span>;</pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: #f4f4f4; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">    String resourceName = <span style="color: #006080">&quot;a/helloworld.png&quot;</span>;</pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: white; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">&nbsp;</pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: #f4f4f4; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">    <span style="color: #008000">// 获取某Deployment中所有的文件资源的名称</span></pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: white; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">    Set set = processEngine.getRepositoryService().getResourceNames(deploymentId);</pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: #f4f4f4; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">    <span style="color: #0000ff">for</span> (String s : set) {</pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: white; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">        System.out.println(s);</pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: #f4f4f4; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">    }</pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: white; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">&nbsp;</pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: #f4f4f4; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">    <span style="color: #008000">// 获取某Deployment中某资源的InputStream（内容）</span></pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: white; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">    InputStream in = processEngine.getRepositoryService().getResourceAsStream(deploymentId, resourceName);</pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: #f4f4f4; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">    <span style="color: #008000">// 保存到 c盘</span></pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: white; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">    FileOutputStream out = <span style="color: #0000ff">new</span> FileOutputStream(<span style="color: #006080">&quot;c:/processImage.png&quot;</span>);</pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: #f4f4f4; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">    <span style="color: #0000ff">for</span> (<span style="color: #0000ff">int</span> b = -1; (b = in.read()) != -1;) {</pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: white; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">        out.write(b);</pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: #f4f4f4; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">    }</pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: white; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">    in.close();</pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: #f4f4f4; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">    out.close();</pre><!--CRLF--><pre style="text-align: left; line-height: 12pt; background-color: white; margin: 0em; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 10pt; overflow: visible; border-style: none; padding: 0px;">}</pre><!--CRLF--></div></div><p><strong>流程变量</strong></p><p>上面的流程在执行的时候,没有带任何有关受理人的信息以及意见,通常在流程执行的过程中,应该记录当前活动(Activity)的数据,比如同意的理由或者不同意的理由等,这些信息通过流程变量存进数据库.流程变量也是有作用域的,与流程实例的生命周期相同,流程变量可以在流程实例的各个活动中获取和设置,假设我现在有个请假的流程定义:</p><p><a target=_blank href="http://hi.csdn.net/attachment/201104/15/0_1302875501whh1.gif"><img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" src="http://hi.csdn.net/attachment/201104/15/0_1302875502rR00.gif" border="0" alt="image" width="626" height="256" /></a></p><p>它就是一个大大的Map,存入的流程变量都会被存入数据库中.流程变量的设置大致可以分为两种:</p><ul><li>顺便设置</li></ul><blockquote><p>ExecutionService.startProcessInstanceByKey(processDefinitionId, variables);</p><p>TaskService.completeTask(taskId, variables);</p></blockquote><ul><li>专门设置</li></ul><blockquote><p>// 通过Execution设置一个流程变量<br />ExecutionService.setVariable(executionId, name, value);<br />// 通过Execution设置多个流程变量<br />ExecutionService.setVariables(executionId, variables)<br />// 通过Task设置多个流程变量<br />processEngine.getTaskService().setVariables(taskId, variables);</p></blockquote><p>不管是以何种方式设置,如果是以给定taskId,它将会根据taskId找到当前的execution,然后才设置.对应的获取也有两种方式:</p><blockquote><p>// 通过Execution获取流程变量的信息<br />ExecutionService.getVariable(executionId, variableName);<br />ExecutionService.getVariableNames(executionId);<br />ExecutionService.getVariables(executionId, variableNames);<br />// 通过Task获取流程变量的信息<br />TaskService.getVariable(taskId, variableName);<br />TaskService.getVariableNames(taskId);<br />TaskService.getVariables(taskId, variableNames);</p></blockquote><p>最后找到execution对应的流程变量.</p><p>总结一下一个工作流系统的工作流程:</p><ol><li>申请模板可以自由定制。</li><li>申请模板对应的流程（步骤）可以自由定制。</li><li>让文件或表单等按预定的步骤进行流转。</li></ol><p>第二步又可分为以下几步:</p><ol><li>要有流程设计器（画图）：需要把所有规则整理清楚，并实现，最终是想能覆盖尽可能多的情况。</li><li>设计完流程后，结果是：图片，给用户看的;xml，给计算机看的。</li></ol>