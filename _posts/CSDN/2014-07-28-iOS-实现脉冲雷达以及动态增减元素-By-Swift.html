---
layout: post
title: 'iOS 实现脉冲雷达以及动态增减元素 By Swift'
date: 2014-07-28 01:31:12 +0800
categories: [iOS,Swift]
csdn_read_num: 15766
article_type: 1
---


<h2>开始之前</h2><br /><div>Swift经过Xcode6 Beta4一版更新后，基本上已经可以作为生产工具了，虽然有一些地方和ObjC比起来要“落后”一些，但也无伤大雅。这里就用Xcode6 Beta4+iOS SDK 8.0开发，如果用ObjC的话，只需把某些语法和调用方式替换一下就可以了。</div><div>最终效果：</div><div><img src="https://img-blog.csdn.net/20140728013055728" width="318" height="566" alt="" /><br /></div><div><span style="font-style:italic; font-weight:bold">这效果是从MOV文件转成GIF的，而且CSDN不支持大于2M的图片上传,</span><strong><em><a target=_blank target="_blank" href="http://v.youku.com/v_show/id_XNzQ3MTIwNjI0.html">优酷地址</a></em></strong></div><h2>创建基本动画</h2><br /><p><img src="https://img-blog.csdn.net/20140727131305736" alt="" width="320" height="568" /></p><p><strong><em>这效果是从MOV文件转成GIF的，而且CSDN不支持大于2M的图片上传,<a target=_blank target="_blank" href="http://v.youku.com/v_show/id_XNzQ2ODgyMjA0.html">优酷地址</a></em></strong></p><p>创建一个Single View Application工程，再创建一个Swift文件，我创建的叫“PulsingRadarView”，目前结构为：</p><p><img src="https://img-blog.csdn.net/20140727141604702" width="267" height="245" alt="" /><br /></p><p>在ViewController里面持有一个Optional的PulsingRadarView的属性，表示可以为nil，然后在viewDidLoad里做一个简单的初始化工作：</p><p><div style="font-family: sans-serif; font-size: 16px; margin: 10px 0px !important; line-height: 110% !important; background-color: rgb(248, 248, 255) !important; border: 1px solid rgba(0, 0, 0, 0.14902) !important; padding: 8.5px !important; border-top-left-radius: 4px !important; border-top-right-radius: 4px !important; border-bottom-right-radius: 4px !important; border-bottom-left-radius: 4px !important;"><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;"><span style="color: rgb(187, 44, 162);">class</span>&nbsp;ViewController:&nbsp;<span style="color: rgb(112, 61, 170);">UIViewController</span>&nbsp;{</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo; color: rgb(79, 129, 135);"><span style="color: rgb(0, 0, 0);">&nbsp; &nbsp;&nbsp;</span><span style="color: rgb(187, 44, 162);">var</span><span style="color: rgb(0, 0, 0);">&nbsp;radarView:&nbsp;</span>PulsingRadarView!</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp;&nbsp;<span style="color: rgb(187, 44, 162);">override</span>&nbsp;<span style="color: rgb(187, 44, 162);">func</span>&nbsp;viewDidLoad() {</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<span style="color: rgb(187, 44, 162);">super</span>.<span style="color: rgb(61, 29, 129);">viewDidLoad</span>()</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo; min-height: 13px;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo; color: rgb(112, 61, 170);"><span style="color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span><span style="color: rgb(187, 44, 162);">let</span><span style="color: rgb(0, 0, 0);">&nbsp;radarSize =&nbsp;</span><span style="color: rgb(61, 29, 129);">CGSizeMake</span><span style="color: rgb(0, 0, 0);">(</span><span style="color: rgb(187, 44, 162);">self</span><span style="color: rgb(0, 0, 0);">.</span>view<span style="color: rgb(0, 0, 0);">.</span>bounds<span style="color: rgb(0, 0, 0);">.</span>size<span style="color: rgb(0, 0, 0);">.</span>width<span style="color: rgb(0, 0, 0);">,&nbsp;</span><span style="color: rgb(187, 44, 162);">self</span><span style="color: rgb(0, 0, 0);">.</span>view<span style="color: rgb(0, 0, 0);">.</span>bounds<span style="color: rgb(0, 0, 0);">.</span>size<span style="color: rgb(0, 0, 0);">.</span>width<span style="color: rgb(0, 0, 0);">)</span></p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<span style="color: rgb(79, 129, 135);">radarView</span>&nbsp;=&nbsp;<span style="color: rgb(79, 129, 135);">PulsingRadarView</span>(frame:&nbsp;<span style="color: rgb(61, 29, 129);">CGRectMake</span>(<span style="color: rgb(39, 42, 216);">0</span>,(<span style="color: rgb(187, 44, 162);">self</span>.<span style="color: rgb(112, 61, 170);">view</span>.<span style="color: rgb(112, 61, 170);">bounds</span>.<span style="color: rgb(112, 61, 170);">size</span>.<span style="color: rgb(112, 61, 170);">height</span><span style="color: rgb(61, 29, 129);">-</span>radarSize.<span style="color: rgb(112, 61, 170);">height</span>)<span style="color: rgb(61, 29, 129);">/</span><span style="color: rgb(39, 42, 216);">2</span>,</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; radarSize.<span style="color: rgb(112, 61, 170);">width</span>,radarSize.<span style="color: rgb(112, 61, 170);">height</span>))</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<span style="color: rgb(187, 44, 162);">self</span>.<span style="color: rgb(112, 61, 170);">view</span>.<span style="color: rgb(61, 29, 129);">addSubview</span>(<span style="color: rgb(79, 129, 135);">radarView</span>)</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp; }</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo; min-height: 13px;">&nbsp;&nbsp; &nbsp;</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp;&nbsp;<span style="color: rgb(187, 44, 162);">override</span>&nbsp;<span style="color: rgb(187, 44, 162);">func</span>&nbsp;didReceiveMemoryWarning() {</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo; color: rgb(61, 29, 129);"><span style="color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span><span style="color: rgb(187, 44, 162);">super</span><span style="color: rgb(0, 0, 0);">.</span>didReceiveMemoryWarning<span style="color: rgb(0, 0, 0);">()</span></p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo; color: rgb(0, 132, 0);"><span style="color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span>// Dispose of any resources that can be recreated.</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp; }</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">}</p></div></p><p>雷达是圆形的，所以宽高都是self.view.bounds.size.width。</p><p></p><p>PulsingRadarView里面现在应该是空的，我们首先导入QuartzCore，因为后面动画部分会用到CALayer，然后重写drawRect方法：</p><p><div style="font-family: sans-serif; font-size: 16px; margin: 10px 0px !important; line-height: 110% !important; background-color: rgb(248, 248, 255) !important; border: 1px solid rgba(0, 0, 0, 0.14902) !important; padding: 8.5px !important; border-top-left-radius: 4px !important; border-top-right-radius: 4px !important; border-bottom-right-radius: 4px !important; border-bottom-left-radius: 4px !important;"><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;"><span style="color: rgb(187, 44, 162);">override</span>&nbsp;<span style="color: rgb(187, 44, 162);">func</span>&nbsp;drawRect(rect:&nbsp;<span style="color: rgb(112, 61, 170);">CGRect</span>) {</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo; color: rgb(61, 29, 129);"><span style="color: rgb(0, 0, 0);">&nbsp; &nbsp;&nbsp;</span><span style="color: rgb(112, 61, 170);">UIColor</span><span style="color: rgb(0, 0, 0);">.</span>whiteColor<span style="color: rgb(0, 0, 0);">().</span>setFill<span style="color: rgb(0, 0, 0);">()</span></p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp;&nbsp;<span style="color: rgb(61, 29, 129);">UIRectFill</span>(rect)</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo; min-height: 13px;">&nbsp;&nbsp; &nbsp;</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp;&nbsp;<span style="color: rgb(187, 44, 162);">let</span>&nbsp;pulsingCount =&nbsp;<span style="color: rgb(39, 42, 216);">6</span></p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp;&nbsp;<span style="color: rgb(187, 44, 162);">let</span>&nbsp;animationDuration:&nbsp;<span style="color: rgb(112, 61, 170);">Double</span>&nbsp;=&nbsp;<span style="color: rgb(39, 42, 216);">4</span></p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo; min-height: 13px;">&nbsp;&nbsp; &nbsp;</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp;&nbsp;<span style="color: rgb(187, 44, 162);">var</span>&nbsp;animationLayer =&nbsp;<span style="color: rgb(112, 61, 170);">CALayer</span>()</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp;&nbsp;<span style="color: rgb(187, 44, 162);">for</span>&nbsp;<span style="color: rgb(187, 44, 162);">var</span>&nbsp;i =&nbsp;<span style="color: rgb(39, 42, 216);">0</span>; i &lt; pulsingCount; i++ {</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<span style="color: rgb(187, 44, 162);">var</span>&nbsp;pulsingLayer =&nbsp;<span style="color: rgb(112, 61, 170);">CALayer</span>()</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp; &nbsp; &nbsp; pulsingLayer.<span style="color: rgb(112, 61, 170);">frame</span>&nbsp;=&nbsp;<span style="color: rgb(61, 29, 129);">CGRectMake</span>(<span style="color: rgb(39, 42, 216);">0</span>,&nbsp;<span style="color: rgb(39, 42, 216);">0</span>, rect.<span style="color: rgb(112, 61, 170);">size</span>.<span style="color: rgb(112, 61, 170);">width</span>, rect.<span style="color: rgb(112, 61, 170);">size</span>.<span style="color: rgb(112, 61, 170);">height</span>)</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp; &nbsp; &nbsp; pulsingLayer.<span style="color: rgb(112, 61, 170);">borderColor</span>&nbsp;=&nbsp;<span style="color: rgb(112, 61, 170);">UIColor</span>.<span style="color: rgb(61, 29, 129);">grayColor</span>().<span style="color: rgb(112, 61, 170);">CGColor</span></p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp; &nbsp; &nbsp; pulsingLayer.<span style="color: rgb(112, 61, 170);">borderWidth</span>&nbsp;=&nbsp;<span style="color: rgb(39, 42, 216);">1</span></p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp; &nbsp; &nbsp; pulsingLayer.<span style="color: rgb(112, 61, 170);">cornerRadius</span>&nbsp;= rect.<span style="color: rgb(112, 61, 170);">size</span>.<span style="color: rgb(112, 61, 170);">height</span>&nbsp;<span style="color: rgb(61, 29, 129);">/</span>&nbsp;<span style="color: rgb(39, 42, 216);">2</span></p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo; min-height: 13px;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo; color: rgb(112, 61, 170);"><span style="color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span><span style="color: rgb(187, 44, 162);">var</span><span style="color: rgb(0, 0, 0);">&nbsp;defaultCurve =&nbsp;</span>CAMediaTimingFunction<span style="color: rgb(0, 0, 0);">(name:&nbsp;</span>kCAMediaTimingFunctionDefault<span style="color: rgb(0, 0, 0);">)</span></p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo; min-height: 13px;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<span style="color: rgb(187, 44, 162);">var</span>&nbsp;animationGroup =&nbsp;<span style="color: rgb(112, 61, 170);">CAAnimationGroup</span>()</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo; color: rgb(112, 61, 170);"><span style="color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; animationGroup.</span>fillMode<span style="color: rgb(0, 0, 0);">&nbsp;=&nbsp;</span>kCAFillModeBackwards</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp; &nbsp; &nbsp; animationGroup.<span style="color: rgb(112, 61, 170);">beginTime</span>&nbsp;=&nbsp;<span style="color: rgb(61, 29, 129);">CACurrentMediaTime</span>() +&nbsp;<span style="color: rgb(112, 61, 170);">Double</span>(i) * animationDuration /&nbsp;<span style="color: rgb(112, 61, 170);">Double</span>(pulsingCount)</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp; &nbsp; &nbsp; animationGroup.<span style="color: rgb(112, 61, 170);">duration</span>&nbsp;= animationDuration</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp; &nbsp; &nbsp; animationGroup.<span style="color: rgb(112, 61, 170);">repeatCount</span>&nbsp;=&nbsp;<span style="color: rgb(112, 61, 170);">HUGE</span></p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp; &nbsp; &nbsp; animationGroup.<span style="color: rgb(112, 61, 170);">timingFunction</span>&nbsp;= defaultCurve</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo; min-height: 13px;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<span style="color: rgb(187, 44, 162);">var</span>&nbsp;scaleAnimation =&nbsp;<span style="color: rgb(112, 61, 170);">CABasicAnimation</span>(keyPath:&nbsp;<span style="color: rgb(209, 47, 27);">&quot;transform.scale&quot;</span>)</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp; &nbsp; &nbsp; scaleAnimation.<span style="color: rgb(112, 61, 170);">autoreverses</span>&nbsp;=&nbsp;<span style="color: rgb(187, 44, 162);">false</span></p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp; &nbsp; &nbsp; scaleAnimation.<span style="color: rgb(112, 61, 170);">fromValue</span>&nbsp;=&nbsp;<span style="color: rgb(112, 61, 170);">Double</span>(<span style="color: rgb(39, 42, 216);">0</span>)</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp; &nbsp; &nbsp; scaleAnimation.<span style="color: rgb(112, 61, 170);">toValue</span>&nbsp;=&nbsp;<span style="color: rgb(112, 61, 170);">Double</span>(<span style="color: rgb(39, 42, 216);">1.5</span>)</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo; min-height: 13px;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<span style="color: rgb(187, 44, 162);">var</span>&nbsp;opacityAnimation =&nbsp;<span style="color: rgb(112, 61, 170);">CAKeyframeAnimation</span>(keyPath:&nbsp;<span style="color: rgb(209, 47, 27);">&quot;opacity&quot;</span>)</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp; &nbsp; &nbsp; opacityAnimation.<span style="color: rgb(112, 61, 170);">values</span>&nbsp;= [<span style="color: rgb(112, 61, 170);">Double</span>(<span style="color: rgb(39, 42, 216);">1</span>),<span style="color: rgb(112, 61, 170);">Double</span>(<span style="color: rgb(39, 42, 216);">0.7</span>),<span style="color: rgb(112, 61, 170);">Double</span>(<span style="color: rgb(39, 42, 216);">0</span>)]</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp; &nbsp; &nbsp; opacityAnimation.<span style="color: rgb(112, 61, 170);">keyTimes</span>&nbsp;= [<span style="color: rgb(112, 61, 170);">Double</span>(<span style="color: rgb(39, 42, 216);">0</span>),<span style="color: rgb(112, 61, 170);">Double</span>(<span style="color: rgb(39, 42, 216);">0.5</span>),<span style="color: rgb(112, 61, 170);">Double</span>(<span style="color: rgb(39, 42, 216);">1</span>)]</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo; min-height: 13px;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp; &nbsp; &nbsp; animationGroup.<span style="color: rgb(112, 61, 170);">animations</span>&nbsp;= [scaleAnimation,opacityAnimation]</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo; min-height: 13px;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp; &nbsp; &nbsp; pulsingLayer.<span style="color: rgb(61, 29, 129);">addAnimation</span>(animationGroup, forKey:&nbsp;<span style="color: rgb(209, 47, 27);">&quot;pulsing&quot;</span>)</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp; &nbsp; &nbsp; animationLayer.<span style="color: rgb(61, 29, 129);">addSublayer</span>(pulsingLayer)</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp; }</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp;&nbsp;<span style="color: rgb(187, 44, 162);">self</span>.<span style="color: rgb(112, 61, 170);">layer</span>.<span style="color: rgb(61, 29, 129);">addSublayer</span>(animationLayer)</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">}<span style="font-family: sans-serif; font-size: 16px;">&nbsp;</span></p></div></p><p>先设置画布的背影色为白色，pulsingCount表示波形的条数，animationDuration表示动画的时长，然后我创建了一个animationLayer来存放所有的动画Layer------pulsingLayer，这样layer的结构看起来就像：</p><p><img src="https://img-blog.csdn.net/20140727145831578?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvemhhbmdhbzAwODY=/font/5a6L5L2T/fontsize/800/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" width="586" height="151" alt="" /><br /></p><p>每个pulsingLayer代表一个圆形，循环里面先对pulsingLayer进行一些初始化工作：设置frame、边框颜色、边框大小以及radius（半径），radius自然就是自身的宽或高的一半。</p><p>CAMediaTimingFunction稍后再说。</p><p>接下来创建一个AnimationGroup，因为我们需要用到的动画将有两个：scale（缩放）、opacity（透明），而且需要控制动画开始的时间。</p><p>我们借用<a target=_blank target="_blank" href="http://ronnqvi.st/controlling-animation-timing/">Controlling Animation Timing</a>这篇文章中的几张图来说明fillMode、beginTime这两个属性：</p><p>以下每个方格代表1秒钟，下面这张图也就代表4秒钟，动画时间为1.5秒，黄色为动画开始，蓝色为动画结束，黄色到蓝色也就是动画的过程。从图中可以看到，蓝色部分结束后就是白色了，也就代表整个动画结束并且从layer上移除。</p><p><img src="https://img-blog.csdn.net/20140727160547836?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvemhhbmdhbzAwODY=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" width="562" height="208" alt="" /><br /></p><p>下面这张图开始动画时间偏移了1秒，其余不变。</p><p><img src="https://img-blog.csdn.net/20140727160812281?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvemhhbmdhbzAwODY=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="" /><br /></p><p>默认情况下，所有的Layer无论创建的先后顺序有何不同，它们的时间线都是一致的，beginTime为0，表示加入Layer之后就立即开始动画（或者说在当前时间播放动画），而如果要偏移1秒（如上图），则要CACurrentMediaTime()+1，获取当前系统的<strong>绝对时间</strong>（秒数）并+1。我们要实现脉冲效果，就要使每一个animationGroup的动画以不同的beginTime来进行，所以要设置beginTime =&nbsp;CACurrentMediaTime() + Double(i) * animationDuration / Double(pulsingCount)，Swift不支持隐式类型转换，用Double()显式的强转一下。</p><p>但是通过上图可以看到，偏移后动画开始前有一个空档，这是由fillMode决定的:</p><p></p><ul><li>kCAFillModeRemoved <span style="white-space:pre"></span>默认值,在动画开始前和动画结束后,动画对layer都没有影响,layer原本是什么样就是什么样</li><li>kCAFillModeForwards <span style="white-space:pre"></span>当动画结束后,layer会一直保持着动画最后的状态</li><li>kCAFillModeBackwards <span style="white-space:pre"></span>和kCAFillModeForwards相对,具体参考上面的</li><li>kCAFillModeBoth <span style="white-space:pre"></span>kCAFillModeForwards和kCAFillModeBackwards在一起的效果</li></ul><div>在我们现在的这种情况下，pulsingLayer是设置过frame和border的，所以在动画的空档期，pulsingLayer会直接显示出一个带边框的圆形（动画还没有开始），当然，在动画播放过一次之后，这个边框就不会显示了，因为进入了正常的动画播放循环，不会出现空档期。我们只需要避免在动画播放前不出现空档期就行了，即设置fillMode =&nbsp;kCAFillModeBackwards（提前进入动画状态）。</div><div><img src="https://img-blog.csdn.net/20140727172741891?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvemhhbmdhbzAwODY=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="" /><br /></div><div>repeatCount = HUGE就是字面意思，表示动画无限循环（HUGE可以认为是无限，如果是ObjC，用HUGE_VAL）。</div><div>CAMediaTimingFunction由系统预置了几个值：<br /></div><div><ul><li>kCAMediaTimingFunctionLinear <span style="white-space:pre"></span>线性,即匀速&nbsp;</li><li>kCAMediaTimingFunctionEaseIn <span style="white-space:pre"></span>先慢后快&nbsp;</li><li>kCAMediaTimingFunctionEaseOut <span style="white-space:pre"></span>先快后慢&nbsp;</li><li>kCAMediaTimingFunctionEaseInEaseOut <span style="white-space:pre"></span>先慢后快再慢&nbsp;</li><li>kCAMediaTimingFunctionDefault <span style="white-space:pre"></span>实际效果是在动画开始时和动画播放时比较快,将结束时会变慢</li></ul><div>CAMediaTimingFunction支持被定制。我们把timingFunction设置为kCAMediaTimingFunctionDefault，可以使动画播放的更加动感。<br /></div></div><div>接下来的Scale动画就很简单了，从0（0倍）到1.5（放大1.5倍）变换即可。</div><div>Opacity透明动画只用设置values和与其对应的keyTimes就行了，需要注意的是keyTimes表示的是时间比例，取值0到1之间，如values的第一个元素为1，keyTimes第一个元素为0，表示动画开始时，opacity为1；values的第二个元素为0.7，keyTimes第二个元素为0.5，表示动画播放到一半的时候，opacity为0.7；依次类推，可自由定制。</div><div>然后将单独的scale动画与opacity动画封装到animationGroup里，在把包含了两个动画的animationGroup给pulsingLayer，animationLayer添加pulsingLayer，最后添加这个包含了所有动画Layer的animationLayer即可。</div><div><br /></div><h2>动态增减元素</h2><div><img src="https://img-blog.csdn.net/20140727190538078" width="318" height="566" alt="" /><p></p></div><p><strong><em>这效果是从MOV文件转成GIF的，而且CSDN不支持大于2M的图片上传,<a target=_blank target="_blank" href="http://v.youku.com/v_show/id_XNzQ2OTY0OTcy.html">优酷地址</a></em></strong></p><div>动画部分已经完成了，接下来我们给PulsingRadarView增加接口，使其支持增减元素。</div><div>首先给PulsingRadarView添加两个属性：<span style="font-family: sans-serif; font-size: 16px;">&nbsp;</span></div><div><div style="font-family: sans-serif; font-size: 16px; margin: 10px 0px !important; line-height: 110% !important; background-color: rgb(248, 248, 255) !important; border: 1px solid rgba(0, 0, 0, 0.14902) !important; padding: 8.5px !important; border-top-left-radius: 4px !important; border-top-right-radius: 4px !important; border-bottom-right-radius: 4px !important; border-bottom-left-radius: 4px !important;"><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;"><span style="color: rgb(187, 44, 162);">class</span>&nbsp;PulsingRadarView:&nbsp;<span style="color: rgb(112, 61, 170);">UIView</span>&nbsp;{</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo; min-height: 13px;">&nbsp;&nbsp; &nbsp;</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp;&nbsp;<span style="color: rgb(187, 44, 162);">let</span>&nbsp;itemSize =&nbsp;<span style="color: rgb(61, 29, 129);">CGSizeMake</span>(<span style="color: rgb(39, 42, 216);">44</span>,&nbsp;<span style="color: rgb(39, 42, 216);">44</span>)</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp;&nbsp;<span style="color: rgb(187, 44, 162);">var</span>&nbsp;items =&nbsp;<span style="color: rgb(112, 61, 170);">NSMutableArray</span>()</p></div></div><div>第一个是每个item的尺寸，第二个用来存储所有的item。</div><div>添加addOrReplaceItem公共接口：</div><div><div style="font-family: sans-serif; font-size: 16px; margin: 10px 0px !important; line-height: 110% !important; background-color: rgb(248, 248, 255) !important; border: 1px solid rgba(0, 0, 0, 0.14902) !important; padding: 8.5px !important; border-top-left-radius: 4px !important; border-top-right-radius: 4px !important; border-bottom-right-radius: 4px !important; border-bottom-left-radius: 4px !important;"><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;"><span style="color: rgb(187, 44, 162);">func</span>&nbsp;addOrReplaceItem() {</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp;&nbsp;<span style="color: rgb(187, 44, 162);">let</span>&nbsp;maxCount =&nbsp;<span style="color: rgb(39, 42, 216);">10</span></p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo; min-height: 13px;">&nbsp;&nbsp; &nbsp;</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp;&nbsp;<span style="color: rgb(187, 44, 162);">var</span>&nbsp;radarButton =&nbsp;<span style="color: rgb(112, 61, 170);">UIButton</span>(frame:&nbsp;<span style="color: rgb(61, 29, 129);">CGRectMake</span>(<span style="color: rgb(39, 42, 216);">0</span>,&nbsp;<span style="color: rgb(39, 42, 216);">0</span>,&nbsp;<span style="color: rgb(79, 129, 135);">itemSize</span>.<span style="color: rgb(112, 61, 170);">width</span>,&nbsp;<span style="color: rgb(79, 129, 135);">itemSize</span>.<span style="color: rgb(112, 61, 170);">height</span>))</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp; radarButton.<span style="color: rgb(61, 29, 129);">setImage</span>(<span style="color: rgb(112, 61, 170);">UIImage</span>(named:&nbsp;<span style="color: rgb(209, 47, 27);">&quot;UK&quot;</span>), forState:&nbsp;<span style="color: rgb(112, 61, 170);">UIControlState</span>.Normal)</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo; min-height: 13px;">&nbsp;&nbsp; &nbsp;</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo; color: rgb(49, 89, 93);"><span style="color: rgb(0, 0, 0);">&nbsp; &nbsp;&nbsp;</span><span style="color: rgb(187, 44, 162);">var</span><span style="color: rgb(0, 0, 0);">&nbsp;center =&nbsp;</span>generateCenterPointInRadar<span style="color: rgb(0, 0, 0);">()</span></p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp; radarButton.<span style="color: rgb(112, 61, 170);">center</span>&nbsp;=&nbsp;<span style="color: rgb(61, 29, 129);">CGPointMake</span>(center.<span style="color: rgb(112, 61, 170);">x</span>, center.<span style="color: rgb(112, 61, 170);">y</span>)</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo; min-height: 13px;">&nbsp;&nbsp; &nbsp;</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp;&nbsp;<span style="color: rgb(187, 44, 162);">self</span>.<span style="color: rgb(61, 29, 129);">addSubview</span>(radarButton)</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp;&nbsp;<span style="color: rgb(79, 129, 135);">items</span>.<span style="color: rgb(61, 29, 129);">addObject</span>(radarButton)</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo; min-height: 13px;">&nbsp;&nbsp; &nbsp;</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp;&nbsp;<span style="color: rgb(187, 44, 162);">if</span>&nbsp;<span style="color: rgb(79, 129, 135);">items</span>.<span style="color: rgb(112, 61, 170);">count</span>&nbsp;&gt; maxCount {</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<span style="color: rgb(187, 44, 162);">var</span>&nbsp;view =&nbsp;<span style="color: rgb(79, 129, 135);">items</span>.<span style="color: rgb(61, 29, 129);">objectAtIndex</span>(<span style="color: rgb(39, 42, 216);">0</span>)&nbsp;<span style="color: rgb(187, 44, 162);">as</span>&nbsp;<span style="color: rgb(112, 61, 170);">UIView</span></p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo; color: rgb(61, 29, 129);"><span style="color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp; view.</span>removeFromSuperview<span style="color: rgb(0, 0, 0);">()</span></p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<span style="color: rgb(79, 129, 135);">items</span>.<span style="color: rgb(61, 29, 129);">removeObject</span>(view)</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp; }</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">}<span style="font-family: sans-serif; font-size: 16px;">&nbsp;</span></p></div></div><div>maxCount是圆内显示item的最大值，这里简单的写死，你可以把它开放出去成为一个公共的属性。这里的每个item都是UIButton，初始化后设置一张图片即可，generateCenterPointInRadar方法返回一个圆内的中心坐标，这个坐标只会在圆的直径以内生成，稍后放出。最后判断一下有没有超出maxCount，如果超出了，就把最先添加的item移除掉。</div><div>在放出generateCenterPointInRadar这个方法之前，我们首先要了解，哪个范围是我们的坐标生成范围：</div><div><img src="https://img-blog.csdn.net/20140727215441107?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvemhhbmdhbzAwODY=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" width="320" height="320" alt="" /><br /></div><div>大家都知道，View的基本形状是矩形（红色区域），drawRect是以Rect为基础的，但是我们这个雷达是圆形，也就是蓝色区域才是我们的目标范围，所以生成的坐标要围绕中心的绿点（圆心），让我们重新翻开数学课本，看看高中数学对三角函数的定义：</div><div><blockquote>在一个平面直角坐标系中，以原点为圆心，1 为半径画一个圆，这个圆交 x 轴于 A 点。以 O 为旋转中心，将 A 点逆时针旋转一定的角度α至 B 点，设此时 B 点的坐标是(x,y)，那么此时 y 的值就叫做α的正弦，记作 sinα；此时 x 的值就叫做α的余弦，记作 cosα；y 与 x 的比值 y/x 就叫做α的正切，记作 tanα。</blockquote></div><div>还有一个很重要的公式：<strong><em>圆的参数方程：以点O（a，b）为圆心，以r为半径的圆的参数方程是 x=a+r*cosθ, y=b+r*sinθ, （其中θ为参数）</em></strong></div><div>到这里为止，思路就清晰了，以下是generateCenterPointInRadar的方法实现：</div><div><div style="font-family: sans-serif; font-size: 16px; margin: 10px 0px !important; line-height: 110% !important; background-color: rgb(248, 248, 255) !important; border: 1px solid rgba(0, 0, 0, 0.14902) !important; padding: 8.5px !important; border-top-left-radius: 4px !important; border-top-right-radius: 4px !important; border-bottom-right-radius: 4px !important; border-bottom-left-radius: 4px !important;"><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;"><span style="color: rgb(187, 44, 162);">private</span>&nbsp;<span style="color: rgb(187, 44, 162);">func</span>&nbsp;generateCenterPointInRadar() -&gt;&nbsp;<span style="color: rgb(112, 61, 170);">CGPoint</span>{</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp;&nbsp;<span style="color: rgb(187, 44, 162);">var</span>&nbsp;angle =&nbsp;<span style="color: rgb(112, 61, 170);">Double</span>(<span style="color: rgb(61, 29, 129);">arc4random</span>()) %&nbsp;<span style="color: rgb(39, 42, 216);">360</span></p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp;&nbsp;<span style="color: rgb(187, 44, 162);">var</span>&nbsp;radius =&nbsp;<span style="color: rgb(112, 61, 170);">Double</span>(<span style="color: rgb(61, 29, 129);">arc4random</span>()) % (<span style="color: rgb(112, 61, 170);">Double</span>)((<span style="color: rgb(187, 44, 162);">self</span>.<span style="color: rgb(112, 61, 170);">bounds</span>.<span style="color: rgb(112, 61, 170);">size</span>.<span style="color: rgb(112, 61, 170);">width</span>&nbsp;<span style="color: rgb(61, 29, 129);">-</span>&nbsp;<span style="color: rgb(79, 129, 135);">itemSize</span>.<span style="color: rgb(112, 61, 170);">width</span>)<span style="color: rgb(61, 29, 129);">/</span><span style="color: rgb(39, 42, 216);">2</span>)</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp;&nbsp;<span style="color: rgb(187, 44, 162);">var</span>&nbsp;x =&nbsp;<span style="color: rgb(61, 29, 129);">cos</span>(angle) * radius</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp;&nbsp;<span style="color: rgb(187, 44, 162);">var</span>&nbsp;y =&nbsp;<span style="color: rgb(61, 29, 129);">sin</span>(angle) * radius</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo; color: rgb(112, 61, 170);"><span style="color: rgb(0, 0, 0);">&nbsp; &nbsp;&nbsp;</span><span style="color: rgb(187, 44, 162);">return</span><span style="color: rgb(0, 0, 0);">&nbsp;</span><span style="color: rgb(61, 29, 129);">CGPointMake</span><span style="color: rgb(0, 0, 0);">(</span>CGFloat<span style="color: rgb(0, 0, 0);">(x)&nbsp;</span><span style="color: rgb(61, 29, 129);">+</span><span style="color: rgb(0, 0, 0);">&nbsp;</span><span style="color: rgb(187, 44, 162);">self</span><span style="color: rgb(0, 0, 0);">.</span>bounds<span style="color: rgb(0, 0, 0);">.</span>size<span style="color: rgb(0, 0, 0);">.</span>width<span style="color: rgb(0, 0, 0);">&nbsp;</span><span style="color: rgb(61, 29, 129);">/</span><span style="color: rgb(0, 0, 0);">&nbsp;</span><span style="color: rgb(39, 42, 216);">2</span><span style="color: rgb(0, 0, 0);">,&nbsp;</span>CGFloat<span style="color: rgb(0, 0, 0);">(y)&nbsp;</span><span style="color: rgb(61, 29, 129);">+</span><span style="color: rgb(0, 0, 0);">&nbsp;</span><span style="color: rgb(187, 44, 162);">self</span><span style="color: rgb(0, 0, 0);">.</span>bounds<span style="color: rgb(0, 0, 0);">.</span>size<span style="color: rgb(0, 0, 0);">.</span>height<span style="color: rgb(0, 0, 0);">&nbsp;</span><span style="color: rgb(61, 29, 129);">/</span><span style="color: rgb(0, 0, 0);">&nbsp;</span><span style="color: rgb(39, 42, 216);">2</span><span style="color: rgb(0, 0, 0);">)</span></p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">}</p></div></div><div>我们先在360°以内随机生成一个角度(<strong>θ</strong>)，然后在半径范围内随机生成一个值，就当作是一个新的半径r，利用公式我们得到了x、y的点，有圆心（a，b）为辅助，就能生成一个坐标了，这个坐标在返回时就已经是基于圆心的了，所以在addOrReplaceItem这个接口里我们拿到坐标后就能直接当作center来用了，这实际上也是完全采用的公式的算法。</div><div>这样一来，addOrReplaceItem这个接口也完成了，我们把ViewController里的调用也完善一下，具体的，在viewDidLoad方法的最后增加一个Timer，这个Timer每0.5秒调用一次addOrReplaceItem：</div><div><pre code_snippet_id="436688" snippet_file_name="blog_20140728_6_592860"  code_snippet_id="436688" snippet_file_name="blog_20140728_6_592860" name="code" class="objc">NSTimer.scheduledTimerWithTimeInterval(0.5, target: radarView, selector: Selector(&quot;addOrReplaceItem&quot;), userInfo: nil, repeats: true)</pre>Timer在不用的时候一定要调用invalidate()方法，并且要在ViewController析构之前，不然ViewController不会被释放，也就永远不会被析构。这里我们就不考虑那么多了，毕竟只有一个页面，而且在真实场景里也不会这么去用，更多的情况是在网络请求回调的时候去处理。</div><div>这么一来，动态增减部分也完成了，但是完美了吗？显然没有。<br /><br /></div><h2>优化</h2><h3>优化一</h3><div>与其说是优化，不如说是修复Bug。很明显，在上一步中，我们动态生成的元素重叠了，这不能让人接受，而我们只要稍微做些改变就能防止这种情况的发生。</div><div>我们现在在生成每个item的center的时候，没有和已有的item进行比较，这是一个比较耗性能的操作，如果你的itemSize过大，maxCount过多，这甚至能导致死循环，如果是那样的话，你可能在对itemSize以及maxCount做出限制的同时，也对循环的数量也进行控制，如果在生成一个item的center的时候，进行了过多的循环，就可以视为进入死循环了，在这种情况下，你只能重新计算已有的center<strong>s</strong>。这里不考虑这种极端情况，因为目前的itemSize和maxCount的配合，不会出现死循环。</div><div>我们添加一个itemFrameIntersectsInOtherItem私有方法来判断是否和之前生成的center有了重叠：</div><div><div style="font-family: sans-serif; font-size: 16px; margin: 10px 0px !important; line-height: 110% !important; background-color: rgb(248, 248, 255) !important; border: 1px solid rgba(0, 0, 0, 0.14902) !important; padding: 8.5px !important; border-top-left-radius: 4px !important; border-top-right-radius: 4px !important; border-bottom-right-radius: 4px !important; border-bottom-left-radius: 4px !important;"><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;"><span style="color: rgb(187, 44, 162);">private</span>&nbsp;<span style="color: rgb(187, 44, 162);">func</span>&nbsp;itemFrameIntersectsInOtherItem (frame:&nbsp;<span style="color: rgb(112, 61, 170);">CGRect</span>) -&gt;&nbsp;<span style="color: rgb(112, 61, 170);">Bool</span>&nbsp;{</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp;&nbsp;<span style="color: rgb(187, 44, 162);">for</span>&nbsp;item&nbsp;<span style="color: rgb(187, 44, 162);">in</span>&nbsp;<span style="color: rgb(79, 129, 135);">items</span>&nbsp;{</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<span style="color: rgb(187, 44, 162);">if</span>&nbsp;<span style="color: rgb(61, 29, 129);">CGRectIntersectsRect</span>(item.frame, frame) {</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<span style="color: rgb(187, 44, 162);">return</span>&nbsp;<span style="color: rgb(187, 44, 162);">true</span></p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp; &nbsp; &nbsp; }</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp; }</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo; color: rgb(187, 44, 162);"><span style="color: rgb(0, 0, 0);">&nbsp; &nbsp;&nbsp;</span>return<span style="color: rgb(0, 0, 0);">&nbsp;</span>false</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">}<span style="font-family: sans-serif; font-size: 16px;">&nbsp;</span></p></div></div><div>接收一个frame，然后和每一个item比较，如果重叠返回true，反之则返回false。</div><div>在addOrReplaceItem方法里的改造：</div><div><div style="font-family: sans-serif; font-size: 16px; margin: 10px 0px !important; line-height: 110% !important; background-color: rgb(248, 248, 255) !important; border: 1px solid rgba(0, 0, 0, 0.14902) !important; padding: 8.5px !important; border-top-left-radius: 4px !important; border-top-right-radius: 4px !important; border-bottom-right-radius: 4px !important; border-bottom-left-radius: 4px !important;"><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;"><span style="color: rgb(187, 44, 162);">......</span></p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;"><span style="color: rgb(187, 44, 162);">do</span>&nbsp;{</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp;&nbsp;<span style="color: rgb(187, 44, 162);">var</span>&nbsp;center = generateCenterPointInRadar()</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp; radarButton.center = CGPointMake(center.x, center.y)</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">}&nbsp;<span style="color: rgb(187, 44, 162);">while</span>&nbsp;(itemFrameIntersectsInOtherItem(radarButton.frame))</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">......</p></div></div><div>把设置center的地方用一个do-while循环包装起来即可。这么一来，生成的元素就不会重叠了。<br /><br /></div><h3>优化二</h3><div>我打算给每一个item的显示和移除增加一点动画效果，以免显得太生硬，并且用派生类的方式来实现：</div><div><div style="font-family: sans-serif; font-size: 16px; margin: 10px 0px !important; line-height: 110% !important; background-color: rgb(248, 248, 255) !important; border: 1px solid rgba(0, 0, 0, 0.14902) !important; padding: 8.5px !important; border-top-left-radius: 4px !important; border-top-right-radius: 4px !important; border-bottom-right-radius: 4px !important; border-bottom-left-radius: 4px !important;"><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;"><span style="color: rgb(187, 44, 162);">class</span>&nbsp;PRButton:&nbsp;<span style="color: rgb(112, 61, 170);">UIButton</span>&nbsp;{</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo; min-height: 13px;">&nbsp;&nbsp; &nbsp;</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp;&nbsp;<span style="color: rgb(187, 44, 162);">init(fra</span>m<span style="color: rgb(187, 44, 162);">e: C</span>GRect) {</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;"><span style="color: rgb(112, 61, 170);">&nbsp; &nbsp; &nbsp;</span>&nbsp;&nbsp;&nbsp;<span style="color: rgb(187, 44, 162);">super</span>.<span style="color: rgb(187, 44, 162);">init</span>(frame: frame)</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<span style="color: rgb(187, 44, 162);">self</span>.alpha =&nbsp;<span style="color: rgb(39, 42, 216);">0</span></p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp; }</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo; min-height: 13px;">&nbsp;&nbsp; &nbsp;</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp;&nbsp;<span style="color: rgb(187, 44, 162);">override</span>&nbsp;<span style="color: rgb(187, 44, 162);">func</span>&nbsp;didMoveToWindow(<span style="color: rgb(112, 61, 170);">) {</span></p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;"><span style="color: rgb(112, 61, 170);">&nbsp; &nbsp;</span>&nbsp;&nbsp; &nbsp; super.didMo<span style="color: rgb(209, 47, 27);">veToWindow()</span></p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo; color: rgb(209, 47, 27);">&nbsp; &nbsp; &nbsp; &nbsp; if self.window {</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;"><span style="color: rgb(209, 47, 27);">&nbsp;</span>&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; UIView.animateWithDuration(1, animations: {</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp;&nbsp;<span style="color: rgb(187, 44, 162);">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span>&nbsp;<span style="color: rgb(187, 44, 162);">&nbsp;&nbsp; s</span>elf.alpha = 1</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<span style="color: rgb(187, 44, 162);">&nbsp; &nbsp; }</span>)</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp; &nbsp; &nbsp; }</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp; }</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">}<span style="font-family: sans-serif; font-size: 16px;">&nbsp;</span></p></div></div><div>把addOrReplaceItem中的UIButton替换为PRButton，这样在item被添加的时候，有一个简单的过渡动画，当我准备重写removeFromSuperview的时候，遇到了一点问题：</div><div><img src="https://img-blog.csdn.net/20140728005906250?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvemhhbmdhbzAwODY=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" width="386" height="116" alt="" /><br />在Swift里面，闭包是不能用super的，那只能这样了：</div><div><div style="font-family: sans-serif; font-size: 16px; margin: 10px 0px !important; line-height: 110% !important; background-color: rgb(248, 248, 255) !important; border: 1px solid rgba(0, 0, 0, 0.14902) !important; padding: 8.5px !important; border-top-left-radius: 4px !important; border-top-right-radius: 4px !important; border-bottom-right-radius: 4px !important; border-bottom-left-radius: 4px !important;"><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;"><span style="color: rgb(187, 44, 162);">override</span>&nbsp;<span style="color: rgb(187, 44, 162);">func</span>&nbsp;removeFromSuperview() {</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp;&nbsp;<span style="color: rgb(112, 61, 170);">UIView</span>.<span style="color: rgb(61, 29, 129);">beginAnimations</span>(<span style="color: rgb(209, 47, 27);">&quot;&quot;</span>, context:&nbsp;<span style="color: rgb(187, 44, 162);">nil</span>)</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo; color: rgb(61, 29, 129);"><span style="color: rgb(0, 0, 0);">&nbsp; &nbsp;&nbsp;</span><span style="color: rgb(112, 61, 170);">UIView</span><span style="color: rgb(0, 0, 0);">.</span>setAnimationDuration<span style="color: rgb(0, 0, 0);">(</span><span style="color: rgb(39, 42, 216);">1</span><span style="color: rgb(0, 0, 0);">)</span></p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp;&nbsp;<span style="color: rgb(187, 44, 162);">self</span>.<span style="color: rgb(112, 61, 170);">alpha</span>&nbsp;=&nbsp;<span style="color: rgb(39, 42, 216);">0</span></p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo; color: rgb(209, 47, 27);"><span style="color: rgb(0, 0, 0);">&nbsp; &nbsp;&nbsp;</span><span style="color: rgb(112, 61, 170);">UIView</span><span style="color: rgb(0, 0, 0);">.</span><span style="color: rgb(61, 29, 129);">setAnimationDidStopSelector</span><span style="color: rgb(0, 0, 0);">(</span><span style="color: rgb(112, 61, 170);">Selector</span><span style="color: rgb(0, 0, 0);">(</span>&quot;callSuperRemoveFromSuperview&quot;<span style="color: rgb(0, 0, 0);">))</span></p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo; color: rgb(61, 29, 129);"><span style="color: rgb(0, 0, 0);">&nbsp; &nbsp;&nbsp;</span><span style="color: rgb(112, 61, 170);">UIView</span><span style="color: rgb(0, 0, 0);">.</span>commitAnimations<span style="color: rgb(0, 0, 0);">()</span></p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">}</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo; min-height: 13px;"><br /></p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;"><span style="color: rgb(187, 44, 162);">private</span>&nbsp;<span style="color: rgb(187, 44, 162);">func</span>&nbsp;callSuperRemoveFromSuperview() {</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo; color: rgb(61, 29, 129);"><span style="color: rgb(0, 0, 0);">&nbsp; &nbsp;&nbsp;</span><span style="color: rgb(187, 44, 162);">super</span><span style="color: rgb(0, 0, 0);">.</span>removeFromSuperview<span style="color: rgb(0, 0, 0);">()</span></p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">}<span style="font-family: sans-serif; font-size: 16px;">&nbsp;</span></p></div></div><div>运行起来应该可以看到完整的效果了。</div><div><br /></div><h3>优化三</h3><div>这个同样也是修复Bug。如果在动画播放的时候你按下Home键（模拟器按下command+shift+h），就会出现下面这种情况：</div><div><img src="https://img-blog.csdn.net/20140728010611073?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvemhhbmdhbzAwODY=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" width="320" height="568" alt="" /><br /></div><div>这是因为在按下Home键的时候，所有的动画被移除了，具体的，每个Layer都调用了removeAllAnimations方法。我们如果想要在回到应用程序的时候继续动画，需要监听系统的<strong>UIApplicationDidBecomeActiveNotification</strong>通知：</div><div><div style="font-family: sans-serif; font-size: 16px; margin: 10px 0px !important; line-height: 110% !important; background-color: rgb(248, 248, 255) !important; border: 1px solid rgba(0, 0, 0, 0.14902) !important; padding: 8.5px !important; border-top-left-radius: 4px !important; border-top-right-radius: 4px !important; border-bottom-right-radius: 4px !important; border-bottom-left-radius: 4px !important;"><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;"><span style="color: rgb(187, 44, 162);">weak</span>&nbsp;<span style="color: rgb(187, 44, 162);">var</span>&nbsp;animationLayer:&nbsp;<span style="color: rgb(112, 61, 170);">CALayer</span>?</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo; min-height: 13px;"><br /></p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;"><span style="color: rgb(187, 44, 162);">override</span>&nbsp;<span style="color: rgb(187, 44, 162);">init</span>(frame:&nbsp;<span style="color: rgb(112, 61, 170);">CGRect</span>) {</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp;&nbsp;<span style="color: rgb(187, 44, 162);">super</span>.<span style="color: rgb(187, 44, 162);">init</span>(frame: frame)</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo; min-height: 13px;">&nbsp;&nbsp; &nbsp;</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo; color: rgb(61, 29, 129);"><span style="color: rgb(0, 0, 0);">&nbsp; &nbsp;&nbsp;</span><span style="color: rgb(112, 61, 170);">NSNotificationCenter</span><span style="color: rgb(0, 0, 0);">.</span>defaultCenter<span style="color: rgb(0, 0, 0);">().</span>addObserver<span style="color: rgb(0, 0, 0);">(</span><span style="color: rgb(187, 44, 162);">self</span><span style="color: rgb(0, 0, 0);">,</span></p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; selector:&nbsp;<span style="color: rgb(112, 61, 170);">Selector</span>(<span style="color: rgb(209, 47, 27);">&quot;resume&quot;</span>),</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; name:&nbsp;<span style="color: rgb(112, 61, 170);">UIApplicationDidBecomeActiveNotification</span>,</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; object:&nbsp;<span style="color: rgb(187, 44, 162);">nil</span>)</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">}</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;"><br /></p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;"><span style="color: rgb(187, 44, 162);">required</span>&nbsp;<span style="color: rgb(187, 44, 162);">init</span>(coder aDecoder:&nbsp;<span style="color: rgb(112, 61, 170);">NSCoder</span>) {</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo; color: rgb(209, 47, 27);"><span style="color: rgb(0, 0, 0);">&nbsp; &nbsp;&nbsp;</span><span style="color: rgb(61, 29, 129);">fatalError</span><span style="color: rgb(0, 0, 0);">(</span>&quot;init(coder:) has not been implemented&quot;<span style="color: rgb(0, 0, 0);">)</span></p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">}</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo; min-height: 13px;"><br /></p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;"><span style="color: rgb(187, 44, 162);">func</span>&nbsp;resume() {</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp;&nbsp;<span style="color: rgb(187, 44, 162);">if</span>&nbsp;<span style="color: rgb(187, 44, 162);">let</span>&nbsp;animationLayer =&nbsp;<span style="color: rgb(187, 44, 162);">self</span>.<span style="color: rgb(79, 129, 135);">animationLayer</span>&nbsp;{</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp; &nbsp; &nbsp; animationLayer.<span style="color: rgb(61, 29, 129);">removeFromSuperlayer</span>()</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo; color: rgb(61, 29, 129);"><span style="color: rgb(0, 0, 0);">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span><span style="color: rgb(187, 44, 162);">self</span><span style="color: rgb(0, 0, 0);">.</span>setNeedsDisplay<span style="color: rgb(0, 0, 0);">()</span></p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">&nbsp; &nbsp; }</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">}</p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo; min-height: 13px;"><br /></p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo; color: rgb(187, 44, 162);">deinit<span style="color: rgb(0, 0, 0);">&nbsp;{</span></p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo; color: rgb(61, 29, 129);"><span style="color: rgb(0, 0, 0);">&nbsp; &nbsp;&nbsp;</span><span style="color: rgb(112, 61, 170);">NSNotificationCenter</span><span style="color: rgb(0, 0, 0);">.</span>defaultCenter<span style="color: rgb(0, 0, 0);">().</span>removeObserver<span style="color: rgb(0, 0, 0);">(</span><span style="color: rgb(187, 44, 162);">self</span><span style="color: rgb(0, 0, 0);">)</span></p><p style="margin-top: 0px; margin-bottom: 0px; font-size: 12px; font-family: Menlo;">}</p></div></div><div>这样一来，动画就可以在回到应用程序的时候重新开始了，我把animationLaye以weak的方式引用到了属性里面，这是为了在resume里好方便判断。</div><h2><a target=_blank target="_blank" href="https://github.com/zhangao0086/iOS-PulsingRadar-Swift">GitHub下载地址</a></h2><div><span style="color:rgb(255,0,0); font-family:Arial; font-size:14px; line-height:26px">如果本文有任何问题,请及时指出,以免对后来者产生不必要的困扰,不胜感激!</span><br /></div><div><span style="color:rgb(255,0,0); font-family:Arial; font-size:14px; line-height:26px"><br /></span></div><h2><span style="color:#cc0000;">UPDATED:</span></h2><div>GitHub上的版本已更新至Xcode6 Beta6，在之前下载，然后更新Xcode的朋友，如果编译出现__TFSs26_forceBridgeFromObjectiveCU__FTPSs9AnyObject_MQ__Q_之类的问题，请看<a target=_blank target="_blank" href="http://blog.csdn.net/zhangao0086/article/details/38728479">这里</a>。</div><div>------------------------------------------------------------------------------------------------------</div><div>GitHub上已更新至Xcode 6。</div><div><br /></div>